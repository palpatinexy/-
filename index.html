<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šç­-çªå›Šè´¹è®¡æ—¶å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e68aff 0%, #0984e3 50%, #6c5ce7 100%);
            height: 100vh;
            color: white;
            padding: 10px;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            min-height: 0;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .time-setting {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .time-setting h3 {
            margin-bottom: 10px;
            font-size: 1rem;
            color: #e68aff;
        }

        .time-input-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .time-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 6px 8px;
            color: white;
            font-size: 0.9rem;
            text-align: center;
            width: 50px;
        }

        .salary-setting {
            grid-column: span 2;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .salary-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 1rem;
            width: 120px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #d22eff, #00a085);
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.6);
        }

        .period-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            flex: 1;
            min-height: 0;
        }

        .period-card.morning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.2));
            border-left: 4px solid #ffc107;
        }

        .period-card.afternoon {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(103, 58, 183, 0.2));
            border-left: 4px solid #9c27b0;
        }

        .period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .period-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .period-time {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .countdown-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .countdown-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .countdown-label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .countdown-value {
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .countdown-value.finished {
            color: #d22eff;
            animation: celebration 1s infinite;
        }

        .progress-section {
            margin: 10px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            height: 18px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-bar {
            height: 100%;
            border-radius: 20px;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar.morning {
            background: linear-gradient(90deg, #ffc107, #ff9800);
        }

        .progress-bar.afternoon {
            background: linear-gradient(90deg, #9c27b0, #673ab7);
        }

        .earnings-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            flex-shrink: 0;
        }

        .earnings-title {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #d22eff;
        }

        .earnings-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d22eff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .earnings-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .earnings-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .earnings-item-value {
            font-size: 1rem;
            font-weight: bold;
            color: #e68aff;
        }

        .earnings-item-label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 3px;
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-indicator.active {
            background: #d22eff;
            animation: pulse 2s infinite;
        }

        .status-indicator.finished {
            background: #e68aff;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .style-section {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .style-section h5 {
            margin-bottom: 10px;
            font-size: 1rem;
            color: #e68aff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .style-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .style-row label {
            min-width: 100px;
            color: rgba(255, 255, 255, 0.9);
        }

        .style-row select,
        .style-row input[type="color"],
        .style-row input[type="text"] {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 4px 8px;
            color: white;
            font-size: 0.85rem;
        }

        .style-row select {
            min-width: 100px;
        }

        .style-row input[type="color"] {
            width: 40px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
        }

        .style-row input[type="text"] {
            width: 150px;
        }

        .style-row input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .enhanced-select {
            background: rgba(255, 255, 255, 0.3) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
        }

        .enhanced-select option {
            background: rgba(50, 50, 50, 0.95) !important;
            color: white !important;
            padding: 8px !important;
        }

        .enhanced-select:hover {
            background: rgba(255, 255, 255, 0.4) !important;
        }

        .style-btn {
            font-size: 0.9rem !important;
            padding: 8px 16px !important;
        }

        .small-btn {
            font-size: 0.75rem !important;
            padding: 6px 12px !important;
            border-radius: 15px !important;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .earnings-details {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .title {
                font-size: 1.5rem;
            }

            .countdown-row {
                grid-template-columns: 1fr;
            }

            .earnings-details {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
            <button class="btn style-btn" onclick="toggleStylePanel()">ğŸ¨ æ ·å¼è®¾ç½®</button>
        </div>
        <h1 class="title">ğŸ’¼ ä¸‹ç­å€’è®¡æ—¶</h1>
        <p class="subtitle">ğŸ˜¢ å¿«ç‚¹ä¸‹ç­å§</p>
        <div style="margin-top: 10px; position: relative;">
            <div id="stylePanel" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%); z-index: 999; min-width: 400px; max-width: 500px; background: rgba(45, 55, 72, 0.95); border-radius: 15px; padding: 0; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 13px 13px 0 0; cursor: move; border-bottom: 1px solid rgba(255,255,255,0.2); position: relative;" onmousedown="startDrag(event)">
                    <h4 style="margin: 0; text-align: center; user-select: none;">ğŸ¨ ä¸ªæ€§åŒ–è®¾ç½®</h4>
                    <button onclick="closeStylePanel(event)" style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 30px; height: 30px; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âœ•</button>
                </div>
                <div style="padding: 20px;"
                
                <!-- å­—ä½“è®¾ç½® -->
                <div class="style-section">
                    <h5>ğŸ“ å­—ä½“è®¾ç½®</h5>
                    <div class="style-row">
                        <label>å­—ä½“å¤§å°:</label>
                        <select id="fontSize" onchange="applyStyles()" class="enhanced-select">
                            <option value="small">å°</option>
                            <option value="medium" selected>ä¸­</option>
                            <option value="large">å¤§</option>
                            <option value="xlarge">è¶…å¤§</option>
                        </select>
                    </div>
                    <div class="style-row">
                        <label>å­—ä½“æ ·å¼:</label>
                        <select id="fontFamily" onchange="applyStyles()" class="enhanced-select">
                            <option value="default">é»˜è®¤</option>
                            <option value="serif">å®‹ä½“</option>
                            <option value="sans-serif">é»‘ä½“</option>
                            <option value="monospace">ç­‰å®½å­—ä½“</option>
                            <option value="cursive">æ‰‹å†™ä½“</option>
                        </select>
                    </div>
                </div>

                <!-- èƒŒæ™¯è®¾ç½® -->
                <div class="style-section">
                    <h5>ğŸŒˆ èƒŒæ™¯è®¾ç½®</h5>
                    <div class="style-row">
                        <label>èƒŒæ™¯ç±»å‹:</label>
                        <select id="backgroundType" onchange="toggleBackgroundOptions()" class="enhanced-select">
                            <option value="gradient">æ¸å˜è‰²</option>
                            <option value="solid">çº¯è‰²</option>
                            <option value="image">å›¾ç‰‡</option>
                        </select>
                    </div>
                    <div id="gradientOptions">
                        <div class="style-row">
                            <label>æ¸å˜é¢œè‰²1:</label>
                            <input type="color" id="gradientColor1" value="#e68aff" onchange="applyStyles()">
                        </div>
                        <div class="style-row">
                            <label>æ¸å˜é¢œè‰²2:</label>
                            <input type="color" id="gradientColor2" value="#0984e3" onchange="applyStyles()">
                        </div>
                        <div class="style-row">
                            <label>æ¸å˜é¢œè‰²3:</label>
                            <input type="color" id="gradientColor3" value="#6c5ce7" onchange="applyStyles()">
                        </div>
                    </div>
                    <div id="solidOptions" style="display: none;">
                        <div class="style-row">
                            <label>èƒŒæ™¯é¢œè‰²:</label>
                            <input type="color" id="solidColor" value="#6c5ce7" onchange="applyStyles()">
                        </div>
                    </div>
                    <div id="imageOptions" style="display: none;">
                        <div class="style-row">
                            <label>é€‰æ‹©å›¾ç‰‡:</label>
                            <input type="file" id="backgroundImageFile" accept="image/*" onchange="handleImageUpload(this)" style="display: none;">
                            <button class="btn small-btn" onclick="document.getElementById('backgroundImageFile').click()">ğŸ“ é€‰æ‹©æœ¬åœ°å›¾ç‰‡</button>
                        </div>
                        <div class="style-row">
                            <label>æˆ–è¾“å…¥é“¾æ¥:</label>
                            <input type="text" id="backgroundImage" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥" onchange="applyStyles()">
                        </div>
                    </div>
                </div>

                <!-- æ–‡å­—é¢œè‰²è®¾ç½® -->
                <div class="style-section">
                    <h5>ğŸ¯ æ–‡å­—é¢œè‰²è®¾ç½®</h5>
                    <div class="style-row">
                        <label>æ ‡é¢˜é¢œè‰²:</label>
                        <input type="color" id="titleColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>æ”¶å…¥æ•°å­—é¢œè‰²:</label>
                        <input type="color" id="earningsColor" value="#d22eff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>å€’è®¡æ—¶æ•°å­—é¢œè‰²:</label>
                        <input type="color" id="countdownColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>è¿›åº¦ç™¾åˆ†æ¯”é¢œè‰²:</label>
                        <input type="color" id="progressColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>çŠ¶æ€æ–‡å­—é¢œè‰²:</label>
                        <input type="color" id="statusColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>è®¾ç½®æ ‡ç­¾é¢œè‰²:</label>
                        <input type="color" id="settingLabelColor" value="#e68aff" onchange="applyStyles()">
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                    <button class="btn" onclick="saveCustomStyles()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                    <button class="btn" onclick="resetStyles()">ğŸ”„ é‡ç½®é»˜è®¤</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="left-panel">
            <!-- è®¾ç½®é¢æ¿ -->
            <div class="settings-panel">
                <div class="settings-grid">
                    <div class="time-setting">
                        <h3>ğŸŒ… ä¸Šåˆæ—¶æ®µ</h3>
                        <div class="time-input-row">
                            <span>å¼€å§‹:</span>
                            <input type="number" class="time-input" id="morningStartHour" placeholder="8" min="0"
                                   max="23" value="8">
                            <span>:</span>
                            <input type="number" class="time-input" id="morningStartMin" placeholder="30" min="0"
                                   max="59" value="30">
                        </div>
                        <div class="time-input-row">
                            <span>ç»“æŸ:</span>
                            <input type="number" class="time-input" id="morningEndHour" placeholder="11" min="0"
                                   max="23" value="11">
                            <span>:</span>
                            <input type="number" class="time-input" id="morningEndMin" placeholder="50" min="0" max="59"
                                   value="50">
                        </div>
                    </div>

                    <div class="time-setting">
                        <h3>ğŸŒ† ä¸‹åˆæ—¶æ®µ</h3>
                        <div class="time-input-row">
                            <span>å¼€å§‹:</span>
                            <input type="number" class="time-input" id="afternoonStartHour" placeholder="13" min="0"
                                   max="23" value="13">
                            <span>:</span>
                            <input type="number" class="time-input" id="afternoonStartMin" placeholder="0" min="0"
                                   max="59" value="0">
                        </div>
                        <div class="time-input-row">
                            <span>ç»“æŸ:</span>
                            <input type="number" class="time-input" id="afternoonEndHour" placeholder="17" min="0"
                                   max="23" value="17">
                            <span>:</span>
                            <input type="number" class="time-input" id="afternoonEndMin" placeholder="30" min="0"
                                   max="59" value="30">
                        </div>
                    </div>

                    <div class="salary-setting">
                        <h3>ğŸ’° æ—¥è–ªè®¾ç½®</h3>
                        <div class="time-input-row">
                            <span>æ—¥è–ª:</span>
                            <input type="number" class="salary-input" id="dailySalary" placeholder="200" min="0"
                                   step="0.01">
                            <span>å…ƒ</span>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn" onclick="updateSettings()">ğŸš€ åº”ç”¨è®¾ç½®</button>
                    <span id="saveStatus" style="font-size: 0.8rem; opacity: 0; transition: opacity 0.3s ease;">âœ… å·²ä¿å­˜</span>
                </div>
            </div>

            <!-- æ”¶å…¥ç»Ÿè®¡ -->
            <div class="earnings-section">
                <div class="earnings-title">ğŸ’° ä»Šæ—¥æ”¶å…¥ç»Ÿè®¡</div>
                <div class="earnings-value" id="totalEarnings">Â¥ 0.00</div>
                <div class="earnings-details">
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="morningEarnings">Â¥ 0.00</div>
                        <div class="earnings-item-label">ä¸Šåˆæ”¶å…¥</div>
                    </div>
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="afternoonEarnings">Â¥ 0.00</div>
                        <div class="earnings-item-label">ä¸‹åˆæ”¶å…¥</div>
                    </div>
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="hourlyRate">Â¥ 0.00</div>
                        <div class="earnings-item-label">æ—¶è–ª</div>
                    </div>
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="minuteRate">Â¥ 0.00</div>
                        <div class="earnings-item-label">åˆ†é’Ÿæ”¶å…¥</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- ä¸Šåˆæ—¶æ®µ -->
            <div class="period-card morning">
                <div class="status-indicator" id="morningStatusIndicator"></div>
                <div class="period-header">
                    <div class="period-title">ğŸŒ… ä¸Šåˆæ—¶æ®µ</div>
                    <div class="period-time" id="morningTimeRange">08:30 - 11:50</div>
                </div>

                <div class="countdown-row">
                    <div class="countdown-item">
                        <div class="countdown-label">è·ç¦»ä¸Šåˆç»“æŸ</div>
                        <div class="countdown-value" id="morningCountdown">--:--:--</div>
                    </div>
                    <div class="countdown-item">
                        <div class="countdown-label">ä¸ŠåˆçŠ¶æ€</div>
                        <div class="countdown-value" id="morningStatusText">æœªå¼€å§‹</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>ä¸Šåˆè¿›åº¦</span>
                        <span id="morningProgress">0%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar morning" id="morningProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- ä¸‹åˆæ—¶æ®µ -->
            <div class="period-card afternoon">
                <div class="status-indicator" id="afternoonStatusIndicator"></div>
                <div class="period-header">
                    <div class="period-title">ğŸŒ† ä¸‹åˆæ—¶æ®µ</div>
                    <div class="period-time" id="afternoonTimeRange">13:00 - 17:30</div>
                </div>

                <div class="countdown-row">
                    <div class="countdown-item">
                        <div class="countdown-label">è·ç¦»ä¸‹åˆç»“æŸ</div>
                        <div class="countdown-value" id="afternoonCountdown">--:--:--</div>
                    </div>
                    <div class="countdown-item">
                        <div class="countdown-label">ä¸‹åˆçŠ¶æ€</div>
                        <div class="countdown-value" id="afternoonStatusText">æœªå¼€å§‹</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>ä¸‹åˆè¿›åº¦</span>
                        <span id="afternoonProgress">0%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar afternoon" id="afternoonProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let workSchedule = {
    morning: { start: null, end: null },
    afternoon: { start: null, end: null },
    dailySalary: 0
};
let updateInterval = null;

// æ˜¾ç¤ºä¿å­˜çŠ¶æ€
function showSaveStatus(message = 'âœ… å·²ä¿å­˜', duration = 2000) {
    const statusElement = document.getElementById('saveStatus');
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.style.opacity = '1';
        setTimeout(() => {
            statusElement.style.opacity = '0';
        }, duration);
    }
}

// ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
function saveSettings() {
    const settings = {
        morningStartHour: parseInt(document.getElementById('morningStartHour').value) || 8,
        morningStartMin: parseInt(document.getElementById('morningStartMin').value) || 30,
        morningEndHour: parseInt(document.getElementById('morningEndHour').value) || 11,
        morningEndMin: parseInt(document.getElementById('morningEndMin').value) || 50,
        afternoonStartHour: parseInt(document.getElementById('afternoonStartHour').value) || 13,
        afternoonStartMin: parseInt(document.getElementById('afternoonStartMin').value) || 00,
        afternoonEndHour: parseInt(document.getElementById('afternoonEndHour').value) || 17,
        afternoonEndMin: parseInt(document.getElementById('afternoonEndMin').value) || 30,
        dailySalary: parseFloat(document.getElementById('dailySalary').value) || 00
    };
    
    localStorage.setItem('workTimerSettings', JSON.stringify(settings));
    console.log('è®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨:', settings);
    showSaveStatus();
}

// æ¸…é™¤ä¿å­˜çš„è®¾ç½®
function clearSettings() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„è®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤åˆ°é»˜è®¤å€¼ã€‚')) {
        localStorage.removeItem('workTimerSettings');
        
        // æ¢å¤é»˜è®¤å€¼
        document.getElementById('morningStartHour').value = 8;
        document.getElementById('morningStartMin').value = 30;
        document.getElementById('morningEndHour').value = 11;
        document.getElementById('morningEndMin').value = 50;
        document.getElementById('afternoonStartHour').value = 13;
        document.getElementById('afternoonStartMin').value = 00;
        document.getElementById('afternoonEndHour').value = 17;
        document.getElementById('afternoonEndMin').value = 30;
        document.getElementById('dailySalary').value = '';
        
        console.log('è®¾ç½®å·²æ¸…é™¤ï¼Œæ¢å¤é»˜è®¤å€¼');
        showSaveStatus('ğŸ—‘ï¸ å·²æ¸…é™¤', 2000);
        
        // é‡æ–°åº”ç”¨è®¾ç½®
        updateSettings();
    }
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®
function loadSettings() {
    try {
        const savedSettings = localStorage.getItem('workTimerSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®:', settings);
            
            // æ¢å¤ç•Œé¢è®¾ç½®
            document.getElementById('morningStartHour').value = settings.morningStartHour || 8;
            document.getElementById('morningStartMin').value = settings.morningStartMin || 30;
            document.getElementById('morningEndHour').value = settings.morningEndHour || 11;
            document.getElementById('morningEndMin').value = settings.morningEndMin || 50;
            document.getElementById('afternoonStartHour').value = settings.afternoonStartHour || 13;
            document.getElementById('afternoonStartMin').value = settings.afternoonStartMin || 00;
            document.getElementById('afternoonEndHour').value = settings.afternoonEndHour || 17;
            document.getElementById('afternoonEndMin').value = settings.afternoonEndMin || 30;
            document.getElementById('dailySalary').value = settings.dailySalary || 00;
            
            return settings;
        }
    } catch (error) {
        console.error('åŠ è½½è®¾ç½®æ—¶å‡ºé”™:', error);
    }
    return null;
}

// æ›´æ–°è®¾ç½®
function updateSettings() {
    console.log('updateSettings å‡½æ•°è¢«è°ƒç”¨');
    const today = new Date();
    console.log('å½“å‰æ—¶é—´:', today);

    // è·å–ä¸Šåˆæ—¶é—´è®¾ç½®
    const morningStartHour = parseInt(document.getElementById('morningStartHour').value) || 8;
    const morningStartMin = parseInt(document.getElementById('morningStartMin').value) || 30;
    const morningEndHour = parseInt(document.getElementById('morningEndHour').value) || 11;
    const morningEndMin = parseInt(document.getElementById('morningEndMin').value) || 50;

    // è·å–ä¸‹åˆæ—¶é—´è®¾ç½®
    const afternoonStartHour = parseInt(document.getElementById('afternoonStartHour').value) || 13;
    const afternoonStartMin = parseInt(document.getElementById('afternoonStartMin').value) || 0;
    const afternoonEndHour = parseInt(document.getElementById('afternoonEndHour').value) || 17;
    const afternoonEndMin = parseInt(document.getElementById('afternoonEndMin').value) || 30;

    // è·å–æ—¥è–ªè®¾ç½®
    const dailySalary = parseFloat(document.getElementById('dailySalary').value) || 0;

    console.log('è®¾ç½®å‚æ•°:', {
        morningStartHour, morningStartMin, morningEndHour, morningEndMin,
        afternoonStartHour, afternoonStartMin, afternoonEndHour, afternoonEndMin,
        dailySalary
    });

    // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
    saveSettings();

    // è®¾ç½®å·¥ä½œæ—¶é—´
    workSchedule.morning.start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), morningStartHour, morningStartMin, 0);
    workSchedule.morning.end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), morningEndHour, morningEndMin, 0);
    workSchedule.afternoon.start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), afternoonStartHour, afternoonStartMin, 0);
    workSchedule.afternoon.end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), afternoonEndHour, afternoonEndMin, 0);
    workSchedule.dailySalary = dailySalary;

    console.log('å·¥ä½œæ—¶é—´è¡¨:', workSchedule);

    // æ›´æ–°æ˜¾ç¤ºçš„æ—¶é—´èŒƒå›´
    document.getElementById('morningTimeRange').textContent = `${formatTime(workSchedule.morning.start)} - ${formatTime(workSchedule.morning.end)}`;
    document.getElementById('afternoonTimeRange').textContent = `${formatTime(workSchedule.afternoon.start)} - ${formatTime(workSchedule.afternoon.end)}`;

    // è®¡ç®—æ—¶è–ªå’Œåˆ†é’Ÿæ”¶å…¥
    const totalWorkMinutes = getTotalWorkMinutes();
    const hourlyRate = totalWorkMinutes > 0 ? (dailySalary / (totalWorkMinutes / 60)) : 0;
    const minuteRate = totalWorkMinutes > 0 ? (dailySalary / totalWorkMinutes) : 0;

    document.getElementById('hourlyRate').textContent = `Â¥ ${hourlyRate.toFixed(2)}`;
    document.getElementById('minuteRate').textContent = `Â¥ ${minuteRate.toFixed(4)}`;

    console.log('æ—¶è–ªè®¡ç®—:', { totalWorkMinutes, hourlyRate, minuteRate });

    // å¼€å§‹æ›´æ–°å€’è®¡æ—¶
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    updateCountdown();
    updateInterval = setInterval(updateCountdown, 1000);
    console.log('å€’è®¡æ—¶å·²å¯åŠ¨');
}

// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
function formatTime(date) {
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}

// æ ¼å¼åŒ–å€’è®¡æ—¶æ˜¾ç¤º
function formatCountdown(milliseconds) {
    if (milliseconds <= 0) return '00:00:00';

    const hours = Math.floor(milliseconds / (1000 * 60 * 60));
    const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);

    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// è·å–æ€»å·¥ä½œåˆ†é’Ÿæ•°
function getTotalWorkMinutes() {
    const morningMinutes = (workSchedule.morning.end - workSchedule.morning.start) / (1000 * 60);
    const afternoonMinutes = (workSchedule.afternoon.end - workSchedule.afternoon.start) / (1000 * 60);
    return morningMinutes + afternoonMinutes;
}

// æ›´æ–°å€’è®¡æ—¶å’Œè¿›åº¦
function updateCountdown() {
    const now = new Date();

    // æ›´æ–°ä¸Šåˆæ—¶æ®µ
    updatePeriod('morning', now);

    // æ›´æ–°ä¸‹åˆæ—¶æ®µ
    updatePeriod('afternoon', now);

    // æ›´æ–°æ”¶å…¥ç»Ÿè®¡
    updateEarnings(now);
}

// æ›´æ–°å•ä¸ªæ—¶æ®µ
function updatePeriod(period, now) {
    const start = workSchedule[period].start;
    const end = workSchedule[period].end;

    if (!start || !end) return;

    const statusIndicator = document.getElementById(`${period}StatusIndicator`);
    const countdownElement = document.getElementById(`${period}Countdown`);
    const statusTextElement = document.getElementById(`${period}StatusText`);
    const progressElement = document.getElementById(`${period}Progress`);
    const progressBarElement = document.getElementById(`${period}ProgressBar`);

    let status, countdown, progress;

    // ä¿®å¤æ—¶æ®µåˆ¤æ–­é€»è¾‘
    if (period === 'morning') {
        if (now < start) {
            // ä¸Šåˆæœªå¼€å§‹
            status = 'æœªå¼€å§‹';
            countdown = formatCountdown(start - now);
            progress = 0;
            statusIndicator.className = 'status-indicator';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'æœªå¼€å§‹';
        } else if (now >= start && now <= end) {
            // ä¸Šåˆè¿›è¡Œä¸­
            status = 'è¿›è¡Œä¸­';
            countdown = formatCountdown(end - now);
            const elapsed = now - start;
            const total = end - start;
            progress = (elapsed / total) * 100;
            statusIndicator.className = 'status-indicator active';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'è¿›è¡Œä¸­';
        } else {
            // ä¸Šåˆå·²ç»“æŸ
            status = 'å·²å®Œæˆ';
            countdown = '00:00:00';
            progress = 100;
            statusIndicator.className = 'status-indicator finished';
            countdownElement.className = 'countdown-value finished';
            if (statusTextElement) statusTextElement.textContent = 'å·²å®Œæˆ';
        }
    } else if (period === 'afternoon') {
        if (now < start) {
            // ä¸‹åˆæœªå¼€å§‹ - æ˜¾ç¤ºè·ç¦»ä¸‹åˆå¼€å§‹çš„å€’è®¡æ—¶
            status = 'æœªå¼€å§‹';
            countdown = formatCountdown(start - now);
            progress = 0;
            statusIndicator.className = 'status-indicator';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'æœªå¼€å§‹';
            // ä¿®æ”¹æ ‡ç­¾æ˜¾ç¤ºä¸º"è·ç¦»ä¸‹åˆå¼€å§‹"
            const countdownLabel = countdownElement.parentElement.querySelector('.countdown-label');
            if (countdownLabel) {
                countdownLabel.textContent = 'è·ç¦»ä¸‹åˆå¼€å§‹';
            }
        } else if (now >= start && now <= end) {
            // ä¸‹åˆè¿›è¡Œä¸­
            status = 'è¿›è¡Œä¸­';
            countdown = formatCountdown(end - now);
            const elapsed = now - start;
            const total = end - start;
            progress = (elapsed / total) * 100;
            statusIndicator.className = 'status-indicator active';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'è¿›è¡Œä¸­';
            // æ¢å¤æ ‡ç­¾æ˜¾ç¤ºä¸º"è·ç¦»ä¸‹åˆç»“æŸ"
            const countdownLabel = countdownElement.parentElement.querySelector('.countdown-label');
            if (countdownLabel) {
                countdownLabel.textContent = 'è·ç¦»ä¸‹åˆç»“æŸ';
            }
        } else {
            // ä¸‹åˆå·²ç»“æŸ
            status = 'å·²å®Œæˆ';
            countdown = '00:00:00';
            progress = 100;
            statusIndicator.className = 'status-indicator finished';
            countdownElement.className = 'countdown-value finished';
            if (statusTextElement) statusTextElement.textContent = 'å·²å®Œæˆ';
            // æ¢å¤æ ‡ç­¾æ˜¾ç¤º
            const countdownLabel = countdownElement.parentElement.querySelector('.countdown-label');
            if (countdownLabel) {
                countdownLabel.textContent = 'è·ç¦»ä¸‹åˆç»“æŸ';
            }
        }
    }

    countdownElement.textContent = countdown;
    progressElement.textContent = `${progress.toFixed(1)}%`;
    progressBarElement.style.width = `${progress}%`;
}

// æ›´æ–°æ”¶å…¥ç»Ÿè®¡
function updateEarnings(now) {
    if (workSchedule.dailySalary <= 0) {
        document.getElementById('totalEarnings').textContent = 'Â¥ 0.00';
        document.getElementById('morningEarnings').textContent = 'Â¥ 0.00';
        document.getElementById('afternoonEarnings').textContent = 'Â¥ 0.00';
        return;
    }

    const totalWorkMinutes = getTotalWorkMinutes();
    const minuteRate = workSchedule.dailySalary / totalWorkMinutes;

    // è®¡ç®—ä¸Šåˆæ”¶å…¥
    let morningEarnings = 0;
    const morningStart = workSchedule.morning.start;
    const morningEnd = workSchedule.morning.end;
    if (now > morningStart) {
        const morningWorkedMinutes = Math.min(now - morningStart, morningEnd - morningStart) / (1000 * 60);
        morningEarnings = morningWorkedMinutes * minuteRate;
    }

    // è®¡ç®—ä¸‹åˆæ”¶å…¥
    let afternoonEarnings = 0;
    const afternoonStart = workSchedule.afternoon.start;
    const afternoonEnd = workSchedule.afternoon.end;
    if (now > afternoonStart) {
        const afternoonWorkedMinutes = Math.min(now - afternoonStart, afternoonEnd - afternoonStart) / (1000 * 60);
        afternoonEarnings = afternoonWorkedMinutes * minuteRate;
    }

    const totalEarnings = morningEarnings + afternoonEarnings;

    document.getElementById('totalEarnings').textContent = `Â¥ ${totalEarnings.toFixed(2)}`;
    document.getElementById('morningEarnings').textContent = `Â¥ ${morningEarnings.toFixed(2)}`;
    document.getElementById('afternoonEarnings').textContent = `Â¥ ${afternoonEarnings.toFixed(2)}`;
}

// æ·»åŠ è¾“å…¥éªŒè¯
function addInputValidation() {
    const timeInputs = document.querySelectorAll('.time-input');
    timeInputs.forEach(input => {
        input.addEventListener('input', function() {
            let value = parseInt(this.value);
            if (this.id.includes('Hour')) {
                if (value < 0) this.value = 0;
                if (value > 23) this.value = 23;
            } else {
                if (value < 0) this.value = 0;
                if (value > 59) this.value = 59;
            }
        });
    });

    document.getElementById('dailySalary').addEventListener('input', function() {
        if (parseFloat(this.value) < 0) this.value = 0;
    });
}

// æ·»åŠ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
function addAutoSave() {
    const inputs = [
        'morningStartHour', 'morningStartMin', 'morningEndHour', 'morningEndMin',
        'afternoonStartHour', 'afternoonStartMin', 'afternoonEndHour', 'afternoonEndMin',
        'dailySalary'
    ];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('change', function() {
                // å»¶è¿Ÿä¿å­˜ï¼Œé¿å…é¢‘ç¹ä¿å­˜
                clearTimeout(input.saveTimeout);
                input.saveTimeout = setTimeout(() => {
                    saveSettings();
                    console.log(`${inputId} å·²è‡ªåŠ¨ä¿å­˜`);
                }, 500);
            });
            
            // æ·»åŠ è¾“å…¥æ—¶çš„å®æ—¶åé¦ˆ
            input.addEventListener('input', function() {
                showSaveStatus('ğŸ’¾ æ­£åœ¨ä¿å­˜...', 1000);
            });
        }
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    
    // åŠ è½½ä¿å­˜çš„è®¾ç½®
    const savedSettings = loadSettings();
    
    addInputValidation();
    addAutoSave();

    // å¦‚æœæœ‰ä¿å­˜çš„è®¾ç½®ï¼Œè‡ªåŠ¨åº”ç”¨
    if (savedSettings) {
        console.log('å‘ç°ä¿å­˜çš„è®¾ç½®ï¼Œè‡ªåŠ¨åº”ç”¨...');
        updateSettings();
    } else {
        console.log('æ²¡æœ‰ä¿å­˜çš„è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        // ä½¿ç”¨é»˜è®¤å€¼å¹¶ä¿å­˜
        saveSettings();
        updateSettings();
    }

    // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
    document.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            updateSettings();
        }
    });
    
    console.log('åˆå§‹åŒ–å®Œæˆ');
});

// æ ·å¼è®¾ç½®åŠŸèƒ½
let customStyles = {
    fontSize: 'medium',
    fontFamily: 'default',
    backgroundType: 'gradient',
    gradientColor1: '#e68aff',
    gradientColor2: '#0984e3',
    gradientColor3: '#6c5ce7',
    solidColor: '#6c5ce7',
    backgroundImage: '',
    titleColor: '#ffffff',
    earningsColor: '#d22eff',
    countdownColor: '#ffffff',
    progressColor: '#ffffff',
    statusColor: '#ffffff',
    settingLabelColor: '#e68aff'
};

// åˆ‡æ¢æ ·å¼è®¾ç½®é¢æ¿æ˜¾ç¤º
function toggleStylePanel() {
    const panel = document.getElementById('stylePanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// å…³é—­æ ·å¼è®¾ç½®é¢æ¿
function closeStylePanel(event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘æ‹–åŠ¨
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const panel = document.getElementById('stylePanel');
    panel.style.display = 'none';
    
    // æ·»åŠ ä¸€ä¸ªå°åŠ¨ç”»æ•ˆæœ
    panel.style.opacity = '0';
    setTimeout(() => {
        panel.style.opacity = '1';
    }, 100);
}

// æ‹–åŠ¨åŠŸèƒ½å˜é‡
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

// å¼€å§‹æ‹–åŠ¨
function startDrag(e) {
    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å…³é—­æŒ‰é’®
    if (e.target.onclick && e.target.onclick.toString().includes('closeStylePanel')) {
        return;
    }
    
    const panel = document.getElementById('stylePanel');
    const rect = panel.getBoundingClientRect();
    
    isDragging = true;
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    
    // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
    
    // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
    e.preventDefault();
}

// æ‹–åŠ¨è¿‡ç¨‹
function drag(e) {
    if (!isDragging) return;
    
    const panel = document.getElementById('stylePanel');
    const newX = e.clientX - dragOffsetX;
    const newY = e.clientY - dragOffsetY;
    
    // é™åˆ¶åœ¨çª—å£èŒƒå›´å†…
    const maxX = window.innerWidth - panel.offsetWidth;
    const maxY = window.innerHeight - panel.offsetHeight;
    
    const constrainedX = Math.max(0, Math.min(newX, maxX));
    const constrainedY = Math.max(0, Math.min(newY, maxY));
    
    panel.style.left = constrainedX + 'px';
    panel.style.top = constrainedY + 'px';
    panel.style.transform = 'none'; // ç§»é™¤å±…ä¸­å˜æ¢
}

// åœæ­¢æ‹–åŠ¨
function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
}

// åˆ‡æ¢èƒŒæ™¯é€‰é¡¹æ˜¾ç¤º
function toggleBackgroundOptions() {
    const backgroundType = document.getElementById('backgroundType').value;
    const gradientOptions = document.getElementById('gradientOptions');
    const solidOptions = document.getElementById('solidOptions');
    const imageOptions = document.getElementById('imageOptions');

    gradientOptions.style.display = backgroundType === 'gradient' ? 'block' : 'none';
    solidOptions.style.display = backgroundType === 'solid' ? 'block' : 'none';
    imageOptions.style.display = backgroundType === 'image' ? 'block' : 'none';

    // ç«‹å³åº”ç”¨èƒŒæ™¯æ›´æ”¹
    applyStyles();
}

// å¤„ç†æœ¬åœ°å›¾ç‰‡ä¸Šä¼ 
function handleImageUpload(input) {
    const file = input.files[0];
    if (file) {
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
            alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡ï¼');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // ç¡®ä¿å›¾ç‰‡æ•°æ®æ­£ç¡®è¯»å–
            const imageData = e.target.result;
            console.log('å›¾ç‰‡æ•°æ®é•¿åº¦:', imageData.length);
            console.log('å›¾ç‰‡æ•°æ®å‰100å­—ç¬¦:', imageData.substring(0, 100));
            
            // æ›´æ–°æ ·å¼è®¾ç½®
            customStyles.backgroundImage = imageData;
            customStyles.backgroundType = 'image';
            
            // æ›´æ–°ç•Œé¢æ§ä»¶
            document.getElementById('backgroundType').value = 'image';
            document.getElementById('backgroundImage').value = 'æœ¬åœ°å›¾ç‰‡å·²é€‰æ‹©';
            
            // åˆ‡æ¢æ˜¾ç¤ºé€‰é¡¹
            toggleBackgroundOptions();
            
            // ç«‹å³åº”ç”¨æ ·å¼
            applyStylesForced();
            
            showSaveStatus('ğŸ“ æœ¬åœ°å›¾ç‰‡å·²åŠ è½½', 2000);
        };
        
        reader.onerror = function() {
            alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
        };
        
        reader.readAsDataURL(file);
    }
}

// éªŒè¯å›¾ç‰‡é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
function validateImageUrl(url) {
    return new Promise((resolve) => {
        if (!url || url === 'æœ¬åœ°å›¾ç‰‡å·²é€‰æ‹©') {
            resolve(true);
            return;
        }
        
        const img = new Image();
        const timeoutId = setTimeout(() => {
            resolve(false);
        }, 5000); // 5ç§’è¶…æ—¶
        
        img.onload = function() {
            clearTimeout(timeoutId);
            resolve(true);
        };
        
        img.onerror = function() {
            clearTimeout(timeoutId);
            resolve(false);
        };
        
        img.src = url;
    });
}

// åº”ç”¨æ ·å¼è®¾ç½®
function applyStyles() {
    // è·å–å½“å‰è®¾ç½®å€¼
    customStyles.fontSize = document.getElementById('fontSize').value;
    customStyles.fontFamily = document.getElementById('fontFamily').value;
    customStyles.backgroundType = document.getElementById('backgroundType').value;
    customStyles.gradientColor1 = document.getElementById('gradientColor1').value;
    customStyles.gradientColor2 = document.getElementById('gradientColor2').value;
    customStyles.gradientColor3 = document.getElementById('gradientColor3').value;
    customStyles.solidColor = document.getElementById('solidColor').value;
    
    // å¤„ç†èƒŒæ™¯å›¾ç‰‡
    const backgroundImageInput = document.getElementById('backgroundImage').value;
    if (backgroundImageInput !== customStyles.backgroundImage) {
        customStyles.backgroundImage = backgroundImageInput;
    }
    
    customStyles.titleColor = document.getElementById('titleColor').value;
    customStyles.earningsColor = document.getElementById('earningsColor').value;
    customStyles.countdownColor = document.getElementById('countdownColor').value;
    customStyles.progressColor = document.getElementById('progressColor').value;
    customStyles.statusColor = document.getElementById('statusColor').value;
    customStyles.settingLabelColor = document.getElementById('settingLabelColor').value;

    // åˆ›å»ºæˆ–æ›´æ–°åŠ¨æ€æ ·å¼
    let styleElement = document.getElementById('custom-styles');
    if (!styleElement) {
        styleElement = document.createElement('style');
        styleElement.id = 'custom-styles';
        document.head.appendChild(styleElement);
    }

    // æ„å»ºå­—ä½“å¤§å°æ˜ å°„
    const fontSizeMap = {
        small: '0.8',
        medium: '1',
        large: '1.2',
        xlarge: '1.5'
    };

    // æ„å»ºå­—ä½“å®¶æ—æ˜ å°„
    const fontFamilyMap = {
        default: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
        serif: "'SimSun', serif",
        'sans-serif': "'SimHei', 'Microsoft YaHei', sans-serif",
        monospace: "'Courier New', monospace",
        cursive: "'KaiTi', cursive"
    };

    // æ„å»ºèƒŒæ™¯æ ·å¼
    let backgroundStyle = '';
    switch (customStyles.backgroundType) {
        case 'gradient':
            backgroundStyle = `linear-gradient(135deg, ${customStyles.gradientColor1} 0%, ${customStyles.gradientColor2} 50%, ${customStyles.gradientColor3} 100%)`;
            break;
        case 'solid':
            backgroundStyle = customStyles.solidColor;
            break;
        case 'image':
            if (customStyles.backgroundImage) {
                // å¦‚æœæ˜¯ç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼ŒéªŒè¯å…¶æœ‰æ•ˆæ€§
                if (customStyles.backgroundImage.startsWith('http') && customStyles.backgroundImage !== 'æœ¬åœ°å›¾ç‰‡å·²é€‰æ‹©') {
                    validateImageUrl(customStyles.backgroundImage).then(isValid => {
                        if (!isValid) {
                            alert('å›¾ç‰‡é“¾æ¥æ— æ•ˆæˆ–åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®ï¼\n\nå»ºè®®ï¼š\n1. ç¡®ä¿å›¾ç‰‡é“¾æ¥å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®\n2. å°è¯•ä½¿ç”¨æœ¬åœ°å›¾ç‰‡\n3. æ£€æŸ¥ç½‘ç»œè¿æ¥');
                            // å›é€€åˆ°æ¸å˜èƒŒæ™¯
                            document.getElementById('backgroundType').value = 'gradient';
                            customStyles.backgroundType = 'gradient';
                            document.getElementById('backgroundImage').value = '';
                            customStyles.backgroundImage = '';
                            toggleBackgroundOptions();
                            applyStyles();
                        }
                    });
                }
                backgroundStyle = `url('${customStyles.backgroundImage}') center/cover no-repeat fixed`;
            } else {
                backgroundStyle = `linear-gradient(135deg, ${customStyles.gradientColor1} 0%, ${customStyles.gradientColor2} 50%, ${customStyles.gradientColor3} 100%)`;
            }
            break;
    }

    const dynamicCSS = `
        body {
            background: ${backgroundStyle} !important;
            font-family: ${fontFamilyMap[customStyles.fontFamily]} !important;
            font-size: calc(${fontSizeMap[customStyles.fontSize]}rem * var(--base-font-size, 1)) !important;
        }
        
        .title, .subtitle, .period-title {
            color: ${customStyles.titleColor} !important;
        }
        
        .earnings-title, .earnings-value, .earnings-item-value {
            color: ${customStyles.earningsColor} !important;
        }
        
        .countdown-value {
            color: ${customStyles.countdownColor} !important;
        }
        
        .progress-header span {
            color: ${customStyles.progressColor} !important;
        }
        
        #morningStatusText, #afternoonStatusText, .countdown-label {
            color: ${customStyles.statusColor} !important;
        }
        
        .time-setting h3, .earnings-title, .style-section h5 {
            color: ${customStyles.settingLabelColor} !important;
        }
        
        /* å­—ä½“å¤§å°è°ƒæ•´ */
        .title {
            font-size: calc(1.8rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .subtitle {
            font-size: calc(0.9rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .countdown-value {
            font-size: calc(1.3rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .earnings-value {
            font-size: calc(1.8rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .period-title {
            font-size: calc(1.2rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
    `;

    styleElement.textContent = dynamicCSS;
}

// å¼ºåˆ¶åº”ç”¨æ ·å¼ï¼ˆç”¨äºæœ¬åœ°å›¾ç‰‡ä¸Šä¼ ï¼‰
function applyStylesForced() {
    console.log('å¼ºåˆ¶åº”ç”¨æ ·å¼ï¼ŒèƒŒæ™¯ç±»å‹:', customStyles.backgroundType);
    console.log('èƒŒæ™¯å›¾ç‰‡æ•°æ®:', customStyles.backgroundImage ? customStyles.backgroundImage.substring(0, 50) + '...' : 'null');
    
    // ç›´æ¥è®¾ç½®bodyèƒŒæ™¯
    if (customStyles.backgroundType === 'image' && customStyles.backgroundImage) {
        const backgroundStyle = `url('${customStyles.backgroundImage}') center/cover no-repeat fixed`;
        document.body.style.background = backgroundStyle;
        document.body.style.backgroundAttachment = 'fixed';
        console.log('ç›´æ¥åº”ç”¨èƒŒæ™¯å›¾ç‰‡:', backgroundStyle.substring(0, 100) + '...');
    } else {
        // è°ƒç”¨æ­£å¸¸çš„åº”ç”¨æ ·å¼å‡½æ•°
        applyStyles();
    }
}

// ä¿å­˜è‡ªå®šä¹‰æ ·å¼
function saveCustomStyles() {
    localStorage.setItem('customStyles', JSON.stringify(customStyles));
    showSaveStatus('ğŸ¨ æ ·å¼è®¾ç½®å·²ä¿å­˜', 2000);
    
    // å»¶è¿Ÿå…³é—­é¢æ¿ï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¿å­˜æˆåŠŸçš„æç¤º
    setTimeout(() => {
        closeStylePanel();
    }, 1000);
}

// é‡ç½®æ ·å¼åˆ°é»˜è®¤å€¼
function resetStyles() {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ ·å¼è®¾ç½®åˆ°é»˜è®¤å€¼å—ï¼Ÿ')) {
        // é‡ç½®è®¾ç½®å€¼
        customStyles = {
            fontSize: 'medium',
            fontFamily: 'default',
            backgroundType: 'gradient',
            gradientColor1: '#e68aff',
            gradientColor2: '#0984e3',
            gradientColor3: '#6c5ce7',
            solidColor: '#6c5ce7',
            backgroundImage: '',
            titleColor: '#ffffff',
            earningsColor: '#d22eff',
            countdownColor: '#ffffff',
            progressColor: '#ffffff',
            statusColor: '#ffffff',
            settingLabelColor: '#e68aff'
        };

        // æ›´æ–°ç•Œé¢æ§ä»¶
        loadStylesToInterface();
        
        // åº”ç”¨æ ·å¼
        applyStyles();
        
        // åˆ é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('customStyles');
        
        showSaveStatus('ğŸ”„ å·²é‡ç½®åˆ°é»˜è®¤æ ·å¼', 2000);
    }
}

// å°†æ ·å¼è®¾ç½®åŠ è½½åˆ°ç•Œé¢æ§ä»¶
function loadStylesToInterface() {
    document.getElementById('fontSize').value = customStyles.fontSize;
    document.getElementById('fontFamily').value = customStyles.fontFamily;
    document.getElementById('backgroundType').value = customStyles.backgroundType;
    document.getElementById('gradientColor1').value = customStyles.gradientColor1;
    document.getElementById('gradientColor2').value = customStyles.gradientColor2;
    document.getElementById('gradientColor3').value = customStyles.gradientColor3;
    document.getElementById('solidColor').value = customStyles.solidColor;
    document.getElementById('backgroundImage').value = customStyles.backgroundImage;
    document.getElementById('titleColor').value = customStyles.titleColor;
    document.getElementById('earningsColor').value = customStyles.earningsColor;
    document.getElementById('countdownColor').value = customStyles.countdownColor;
    document.getElementById('progressColor').value = customStyles.progressColor;
    document.getElementById('statusColor').value = customStyles.statusColor;
    document.getElementById('settingLabelColor').value = customStyles.settingLabelColor;
    
    // æ›´æ–°èƒŒæ™¯é€‰é¡¹æ˜¾ç¤º
    toggleBackgroundOptions();
}

// åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰æ ·å¼
function loadCustomStyles() {
    try {
        const saved = localStorage.getItem('customStyles');
        if (saved) {
            customStyles = { ...customStyles, ...JSON.parse(saved) };
            loadStylesToInterface();
            applyStyles();
        }
    } catch (error) {
        console.error('åŠ è½½è‡ªå®šä¹‰æ ·å¼æ—¶å‡ºé”™:', error);
    }
}

// åœ¨é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„æ ·å¼
window.addEventListener('DOMContentLoaded', function() {
    loadCustomStyles();
});
</script>
</body>
</html>