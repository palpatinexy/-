<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šç­-çªå›Šè´¹è®¡æ—¶å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e68aff 0%, #0984e3 50%, #6c5ce7 100%);
            height: 100vh;
            color: white;
            padding: 10px;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            min-height: 0;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .time-setting {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .time-setting h3 {
            margin-bottom: 10px;
            font-size: 1rem;
            color: #e68aff;
        }

        .time-input-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .time-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 6px 8px;
            color: white;
            font-size: 0.9rem;
            text-align: center;
            width: 50px;
        }

        .salary-setting {
            grid-column: span 2;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .salary-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 1rem;
            width: 120px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #d22eff, #00a085);
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.6);
        }

        .period-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            flex: 1;
            min-height: 0;
        }

        .period-card.morning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.2));
            border-left: 4px solid #ffc107;
        }

        .period-card.afternoon {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(103, 58, 183, 0.2));
            border-left: 4px solid #9c27b0;
        }

        .period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .period-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .period-time {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .countdown-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .countdown-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .countdown-label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .countdown-value {
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .countdown-value.finished {
            color: #d22eff;
            animation: celebration 1s infinite;
        }

        .progress-section {
            margin: 10px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            height: 18px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-bar {
            height: 100%;
            border-radius: 20px;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar.morning {
            background: linear-gradient(90deg, #ffc107, #ff9800);
        }

        .progress-bar.afternoon {
            background: linear-gradient(90deg, #9c27b0, #673ab7);
        }

        .earnings-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            flex-shrink: 0;
        }

        .earnings-title {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #d22eff;
        }

        .earnings-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d22eff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .earnings-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .earnings-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .earnings-item-value {
            font-size: 1rem;
            font-weight: bold;
            color: #e68aff;
        }

        .earnings-item-label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 3px;
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-indicator.active {
            background: #d22eff;
            animation: pulse 2s infinite;
        }

        .status-indicator.finished {
            background: #e68aff;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .style-section {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .style-section h5 {
            margin-bottom: 10px;
            font-size: 1rem;
            color: #e68aff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .style-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .style-row label {
            min-width: 100px;
            color: rgba(255, 255, 255, 0.9);
        }

        .style-row select,
        .style-row input[type="color"],
        .style-row input[type="text"] {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 4px 8px;
            color: white;
            font-size: 0.85rem;
        }

        .style-row select {
            min-width: 100px;
        }

        .style-row input[type="color"] {
            width: 40px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
        }

        .style-row input[type="text"] {
            width: 150px;
        }

        .style-row input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .enhanced-select {
            background: rgba(255, 255, 255, 0.3) !important;
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
        }

        .enhanced-select option {
            background: rgba(50, 50, 50, 0.95) !important;
            color: white !important;
            padding: 8px !important;
        }

        .enhanced-select:hover {
            background: rgba(255, 255, 255, 0.4) !important;
        }

        .style-btn {
            font-size: 0.9rem !important;
            padding: 8px 16px !important;
        }

        .small-btn {
            font-size: 0.75rem !important;
            padding: 6px 12px !important;
            border-radius: 15px !important;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .earnings-details {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .title {
                font-size: 1.5rem;
            }

            .countdown-row {
                grid-template-columns: 1fr;
            }

            .earnings-details {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?eff2748c7c24c2f21f8cb8c9acf32a63";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="position: absolute; top: 20px; left: 20px; z-index: 1000;">
            <button class="btn style-btn" onclick="toggleStylePanel()">ğŸ¨ æ ·å¼è®¾ç½®</button>
        </div>
        <h1 class="title">ğŸ’¼ ä¸‹ç­å€’è®¡æ—¶</h1>
        <p class="subtitle">ğŸ˜¢ å¿«ç‚¹ä¸‹ç­å§</p>
        <div style="margin-top: 10px; position: relative;">
            <div id="stylePanel" style="display: none; position: fixed; top: 20%; left: 50%; transform: translateX(-50%); z-index: 999; min-width: 400px; max-width: 500px; background: rgba(45, 55, 72, 0.95); border-radius: 15px; padding: 0; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 13px 13px 0 0; cursor: move; border-bottom: 1px solid rgba(255,255,255,0.2); position: relative;" onmousedown="startDrag(event)">
                    <h4 style="margin: 0; text-align: center; user-select: none;">ğŸ¨ ä¸ªæ€§åŒ–è®¾ç½®</h4>
                    <button onclick="closeStylePanel(event)" style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 30px; height: 30px; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âœ•</button>
                </div>
                <div style="padding: 20px;">
                
                <!-- å­—ä½“è®¾ç½® -->
                <div class="style-section">
                    <h5>ğŸ“ å­—ä½“è®¾ç½®</h5>
                    <div class="style-row">
                        <label>å­—ä½“å¤§å°:</label>
                        <select id="fontSize" onchange="applyStyles()" class="enhanced-select">
                            <option value="small">å°</option>
                            <option value="medium" selected>ä¸­</option>
                            <option value="large">å¤§</option>
                            <option value="xlarge">è¶…å¤§</option>
                        </select>
                    </div>
                    <div class="style-row">
                        <label>å­—ä½“æ ·å¼:</label>
                        <select id="fontFamily" onchange="applyStyles()" class="enhanced-select">
                            <option value="default">é»˜è®¤</option>
                            <option value="serif">å®‹ä½“</option>
                            <option value="sans-serif">é»‘ä½“</option>
                            <option value="monospace">ç­‰å®½å­—ä½“</option>
                            <option value="cursive">æ‰‹å†™ä½“</option>
                        </select>
                    </div>
                </div>

                <!-- èƒŒæ™¯è®¾ç½® -->
                <div class="style-section">
                    <h5>ğŸŒˆ èƒŒæ™¯è®¾ç½®</h5>
                    <div class="style-row">
                        <label>èƒŒæ™¯ç±»å‹:</label>
                        <select id="backgroundType" onchange="toggleBackgroundOptions()" class="enhanced-select">
                            <option value="gradient">æ¸å˜è‰²</option>
                            <option value="solid">çº¯è‰²</option>
                            <option value="image">å›¾ç‰‡</option>
                        </select>
                    </div>
                    <div id="gradientOptions">
                        <div class="style-row">
                            <label>æ¸å˜é¢œè‰²1:</label>
                            <input type="color" id="gradientColor1" value="#e68aff" onchange="applyStyles()">
                        </div>
                        <div class="style-row">
                            <label>æ¸å˜é¢œè‰²2:</label>
                            <input type="color" id="gradientColor2" value="#0984e3" onchange="applyStyles()">
                        </div>
                        <div class="style-row">
                            <label>æ¸å˜é¢œè‰²3:</label>
                            <input type="color" id="gradientColor3" value="#6c5ce7" onchange="applyStyles()">
                        </div>
                    </div>
                    <div id="solidOptions" style="display: none;">
                        <div class="style-row">
                            <label>èƒŒæ™¯é¢œè‰²:</label>
                            <input type="color" id="solidColor" value="#6c5ce7" onchange="applyStyles()">
                        </div>
                    </div>
                    <div id="imageOptions" style="display: none;">
                        <div class="style-row">
                            <label>é€‰æ‹©å›¾ç‰‡:</label>
                            <select id="backgroundImageSelect" onchange="handleImageSelect(this)" class="enhanced-select">
                                <option value="">è¯·é€‰æ‹©å›¾ç‰‡</option>
                            </select>
                            <button class="btn small-btn" onclick="refreshImageList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                        <div class="style-row">
                            <label>æˆ–è¾“å…¥é“¾æ¥:</label>
                            <input type="text" id="backgroundImage" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥" onchange="applyStyles()">
                        </div>
                        <div class="style-row">
                            <label>æ·»åŠ æ–‡ä»¶å:</label>
                            <input type="text" id="customImageName" placeholder="ä¾‹å¦‚: mypic.jpg" style="width: 100px;">
                            <button class="btn small-btn" onclick="addCustomImage()">â• æ·»åŠ </button>
                        </div>
                        <div class="style-row">
                            <label>ç®¡ç†åˆ—è¡¨:</label>
                            <button class="btn small-btn" onclick="showCustomImageManager()">ğŸ“‹ ç®¡ç†è‡ªå®šä¹‰å›¾ç‰‡</button>
                        </div>
                    </div>
                </div>

                <!-- æ–‡å­—é¢œè‰²è®¾ç½® -->
                <div class="style-section">
                    <h5>ğŸ¯ æ–‡å­—é¢œè‰²è®¾ç½®</h5>
                    <div class="style-row">
                        <label>æ ‡é¢˜é¢œè‰²:</label>
                        <input type="color" id="titleColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>æ”¶å…¥æ•°å­—é¢œè‰²:</label>
                        <input type="color" id="earningsColor" value="#d22eff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>å€’è®¡æ—¶æ•°å­—é¢œè‰²:</label>
                        <input type="color" id="countdownColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>è¿›åº¦ç™¾åˆ†æ¯”é¢œè‰²:</label>
                        <input type="color" id="progressColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>çŠ¶æ€æ–‡å­—é¢œè‰²:</label>
                        <input type="color" id="statusColor" value="#ffffff" onchange="applyStyles()">
                    </div>
                    <div class="style-row">
                        <label>è®¾ç½®æ ‡ç­¾é¢œè‰²:</label>
                        <input type="color" id="settingLabelColor" value="#e68aff" onchange="applyStyles()">
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                    <button class="btn" onclick="saveCustomStyles()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                    <button class="btn" onclick="resetStyles()">ğŸ”„ é‡ç½®é»˜è®¤</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="left-panel">
            <!-- è®¾ç½®é¢æ¿ -->
            <div class="settings-panel">
                <div class="settings-grid">
                    <div class="time-setting">
                        <h3>ğŸŒ… ä¸Šåˆæ—¶æ®µ</h3>
                        <div class="time-input-row">
                            <span>å¼€å§‹:</span>
                            <input type="number" class="time-input" id="morningStartHour" placeholder="8" min="0"
                                   max="23" value="8">
                            <span>:</span>
                            <input type="number" class="time-input" id="morningStartMin" placeholder="30" min="0"
                                   max="59" value="30">
                        </div>
                        <div class="time-input-row">
                            <span>ç»“æŸ:</span>
                            <input type="number" class="time-input" id="morningEndHour" placeholder="11" min="0"
                                   max="23" value="11">
                            <span>:</span>
                            <input type="number" class="time-input" id="morningEndMin" placeholder="50" min="0" max="59"
                                   value="50">
                        </div>
                    </div>

                    <div class="time-setting">
                        <h3>ğŸŒ† ä¸‹åˆæ—¶æ®µ</h3>
                        <div class="time-input-row">
                            <span>å¼€å§‹:</span>
                            <input type="number" class="time-input" id="afternoonStartHour" placeholder="13" min="0"
                                   max="23" value="13">
                            <span>:</span>
                            <input type="number" class="time-input" id="afternoonStartMin" placeholder="0" min="0"
                                   max="59" value="0">
                        </div>
                        <div class="time-input-row">
                            <span>ç»“æŸ:</span>
                            <input type="number" class="time-input" id="afternoonEndHour" placeholder="17" min="0"
                                   max="23" value="17">
                            <span>:</span>
                            <input type="number" class="time-input" id="afternoonEndMin" placeholder="30" min="0"
                                   max="59" value="30">
                        </div>
                    </div>

                    <div class="salary-setting">
                        <h3>ğŸ’° æ—¥è–ªè®¾ç½®</h3>
                        <div class="time-input-row">
                            <span>æ—¥è–ª:</span>
                            <input type="number" class="salary-input" id="dailySalary" placeholder="200" min="0"
                                   step="0.01">
                            <span>å…ƒ</span>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn" onclick="updateSettings()">ğŸš€ åº”ç”¨è®¾ç½®</button>
                    <span id="saveStatus" style="font-size: 0.8rem; opacity: 0; transition: opacity 0.3s ease;">âœ… å·²ä¿å­˜</span>
                </div>
            </div>

            <!-- æ”¶å…¥ç»Ÿè®¡ -->
            <div class="earnings-section">
                <div class="earnings-title">ğŸ’° ä»Šæ—¥æ”¶å…¥ç»Ÿè®¡</div>
                <div class="earnings-value" id="totalEarnings">Â¥ 0.00</div>
                <div class="earnings-details">
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="morningEarnings">Â¥ 0.00</div>
                        <div class="earnings-item-label">ä¸Šåˆæ”¶å…¥</div>
                    </div>
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="afternoonEarnings">Â¥ 0.00</div>
                        <div class="earnings-item-label">ä¸‹åˆæ”¶å…¥</div>
                    </div>
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="hourlyRate">Â¥ 0.00</div>
                        <div class="earnings-item-label">æ—¶è–ª</div>
                    </div>
                    <div class="earnings-item">
                        <div class="earnings-item-value" id="minuteRate">Â¥ 0.00</div>
                        <div class="earnings-item-label">åˆ†é’Ÿæ”¶å…¥</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- ä¸Šåˆæ—¶æ®µ -->
            <div class="period-card morning">
                <div class="status-indicator" id="morningStatusIndicator"></div>
                <div class="period-header">
                    <div class="period-title">ğŸŒ… ä¸Šåˆæ—¶æ®µ</div>
                    <div class="period-time" id="morningTimeRange">08:30 - 11:50</div>
                </div>

                <div class="countdown-row">
                    <div class="countdown-item">
                        <div class="countdown-label">è·ç¦»ä¸Šåˆç»“æŸ</div>
                        <div class="countdown-value" id="morningCountdown">--:--:--</div>
                    </div>
                    <div class="countdown-item">
                        <div class="countdown-label">ä¸ŠåˆçŠ¶æ€</div>
                        <div class="countdown-value" id="morningStatusText">æœªå¼€å§‹</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>ä¸Šåˆè¿›åº¦</span>
                        <span id="morningProgress">0%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar morning" id="morningProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- ä¸‹åˆæ—¶æ®µ -->
            <div class="period-card afternoon">
                <div class="status-indicator" id="afternoonStatusIndicator"></div>
                <div class="period-header">
                    <div class="period-title">ğŸŒ† ä¸‹åˆæ—¶æ®µ</div>
                    <div class="period-time" id="afternoonTimeRange">13:00 - 17:30</div>
                </div>

                <div class="countdown-row">
                    <div class="countdown-item">
                        <div class="countdown-label">è·ç¦»ä¸‹åˆç»“æŸ</div>
                        <div class="countdown-value" id="afternoonCountdown">--:--:--</div>
                    </div>
                    <div class="countdown-item">
                        <div class="countdown-label">ä¸‹åˆçŠ¶æ€</div>
                        <div class="countdown-value" id="afternoonStatusText">æœªå¼€å§‹</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>ä¸‹åˆè¿›åº¦</span>
                        <span id="afternoonProgress">0%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar afternoon" id="afternoonProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let workSchedule = {
    morning: { start: null, end: null },
    afternoon: { start: null, end: null },
    dailySalary: 0
};
let updateInterval = null;

// æ˜¾ç¤ºä¿å­˜çŠ¶æ€
function showSaveStatus(message = 'âœ… å·²ä¿å­˜', duration = 2000) {
    const statusElement = document.getElementById('saveStatus');
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.style.opacity = '1';
        setTimeout(() => {
            statusElement.style.opacity = '0';
        }, duration);
    }
}

// ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
function saveSettings() {
    const settings = {
        morningStartHour: parseInt(document.getElementById('morningStartHour').value) || 8,
        morningStartMin: parseInt(document.getElementById('morningStartMin').value) || 30,
        morningEndHour: parseInt(document.getElementById('morningEndHour').value) || 11,
        morningEndMin: parseInt(document.getElementById('morningEndMin').value) || 50,
        afternoonStartHour: parseInt(document.getElementById('afternoonStartHour').value) || 13,
        afternoonStartMin: parseInt(document.getElementById('afternoonStartMin').value) || 00,
        afternoonEndHour: parseInt(document.getElementById('afternoonEndHour').value) || 17,
        afternoonEndMin: parseInt(document.getElementById('afternoonEndMin').value) || 30,
        dailySalary: parseFloat(document.getElementById('dailySalary').value) || 00
    };
    
    localStorage.setItem('workTimerSettings', JSON.stringify(settings));
    console.log('è®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨:', settings);
    showSaveStatus();
}

// æ¸…é™¤ä¿å­˜çš„è®¾ç½®
function clearSettings() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„è®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤åˆ°é»˜è®¤å€¼ã€‚')) {
        localStorage.removeItem('workTimerSettings');
        
        // æ¢å¤é»˜è®¤å€¼
        document.getElementById('morningStartHour').value = 8;
        document.getElementById('morningStartMin').value = 30;
        document.getElementById('morningEndHour').value = 11;
        document.getElementById('morningEndMin').value = 50;
        document.getElementById('afternoonStartHour').value = 13;
        document.getElementById('afternoonStartMin').value = 00;
        document.getElementById('afternoonEndHour').value = 17;
        document.getElementById('afternoonEndMin').value = 30;
        document.getElementById('dailySalary').value = '';
        
        console.log('è®¾ç½®å·²æ¸…é™¤ï¼Œæ¢å¤é»˜è®¤å€¼');
        showSaveStatus('ğŸ—‘ï¸ å·²æ¸…é™¤', 2000);
        
        // é‡æ–°åº”ç”¨è®¾ç½®
        updateSettings();
    }
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®
function loadSettings() {
    try {
        const savedSettings = localStorage.getItem('workTimerSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®:', settings);
            
            // æ¢å¤ç•Œé¢è®¾ç½®
            document.getElementById('morningStartHour').value = settings.morningStartHour || 8;
            document.getElementById('morningStartMin').value = settings.morningStartMin || 30;
            document.getElementById('morningEndHour').value = settings.morningEndHour || 11;
            document.getElementById('morningEndMin').value = settings.morningEndMin || 50;
            document.getElementById('afternoonStartHour').value = settings.afternoonStartHour || 13;
            document.getElementById('afternoonStartMin').value = settings.afternoonStartMin || 00;
            document.getElementById('afternoonEndHour').value = settings.afternoonEndHour || 17;
            document.getElementById('afternoonEndMin').value = settings.afternoonEndMin || 30;
            document.getElementById('dailySalary').value = settings.dailySalary || 00;
            
            return settings;
        }
    } catch (error) {
        console.error('åŠ è½½è®¾ç½®æ—¶å‡ºé”™:', error);
    }
    return null;
}

// æ›´æ–°è®¾ç½®
function updateSettings() {
    console.log('updateSettings å‡½æ•°è¢«è°ƒç”¨');
    const today = new Date();
    console.log('å½“å‰æ—¶é—´:', today);

    // è·å–ä¸Šåˆæ—¶é—´è®¾ç½®
    const morningStartHour = parseInt(document.getElementById('morningStartHour').value) || 8;
    const morningStartMin = parseInt(document.getElementById('morningStartMin').value) || 30;
    const morningEndHour = parseInt(document.getElementById('morningEndHour').value) || 11;
    const morningEndMin = parseInt(document.getElementById('morningEndMin').value) || 50;

    // è·å–ä¸‹åˆæ—¶é—´è®¾ç½®
    const afternoonStartHour = parseInt(document.getElementById('afternoonStartHour').value) || 13;
    const afternoonStartMin = parseInt(document.getElementById('afternoonStartMin').value) || 0;
    const afternoonEndHour = parseInt(document.getElementById('afternoonEndHour').value) || 17;
    const afternoonEndMin = parseInt(document.getElementById('afternoonEndMin').value) || 30;

    // è·å–æ—¥è–ªè®¾ç½®
    const dailySalary = parseFloat(document.getElementById('dailySalary').value) || 0;

    console.log('è®¾ç½®å‚æ•°:', {
        morningStartHour, morningStartMin, morningEndHour, morningEndMin,
        afternoonStartHour, afternoonStartMin, afternoonEndHour, afternoonEndMin,
        dailySalary
    });

    // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
    saveSettings();

    // è®¾ç½®å·¥ä½œæ—¶é—´
    workSchedule.morning.start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), morningStartHour, morningStartMin, 0);
    workSchedule.morning.end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), morningEndHour, morningEndMin, 0);
    workSchedule.afternoon.start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), afternoonStartHour, afternoonStartMin, 0);
    workSchedule.afternoon.end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), afternoonEndHour, afternoonEndMin, 0);
    workSchedule.dailySalary = dailySalary;

    console.log('å·¥ä½œæ—¶é—´è¡¨:', workSchedule);

    // æ›´æ–°æ˜¾ç¤ºçš„æ—¶é—´èŒƒå›´
    document.getElementById('morningTimeRange').textContent = `${formatTime(workSchedule.morning.start)} - ${formatTime(workSchedule.morning.end)}`;
    document.getElementById('afternoonTimeRange').textContent = `${formatTime(workSchedule.afternoon.start)} - ${formatTime(workSchedule.afternoon.end)}`;

    // è®¡ç®—æ—¶è–ªå’Œåˆ†é’Ÿæ”¶å…¥
    const totalWorkMinutes = getTotalWorkMinutes();
    const hourlyRate = totalWorkMinutes > 0 ? (dailySalary / (totalWorkMinutes / 60)) : 0;
    const minuteRate = totalWorkMinutes > 0 ? (dailySalary / totalWorkMinutes) : 0;

    document.getElementById('hourlyRate').textContent = `Â¥ ${hourlyRate.toFixed(2)}`;
    document.getElementById('minuteRate').textContent = `Â¥ ${minuteRate.toFixed(4)}`;

    console.log('æ—¶è–ªè®¡ç®—:', { totalWorkMinutes, hourlyRate, minuteRate });

    // å¼€å§‹æ›´æ–°å€’è®¡æ—¶
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    updateCountdown();
    updateInterval = setInterval(updateCountdown, 1000);
    console.log('å€’è®¡æ—¶å·²å¯åŠ¨');
}

// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
function formatTime(date) {
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}

// æ ¼å¼åŒ–å€’è®¡æ—¶æ˜¾ç¤º
function formatCountdown(milliseconds) {
    if (milliseconds <= 0) return '00:00:00';

    const hours = Math.floor(milliseconds / (1000 * 60 * 60));
    const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);

    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// è·å–æ€»å·¥ä½œåˆ†é’Ÿæ•°
function getTotalWorkMinutes() {
    const morningMinutes = (workSchedule.morning.end - workSchedule.morning.start) / (1000 * 60);
    const afternoonMinutes = (workSchedule.afternoon.end - workSchedule.afternoon.start) / (1000 * 60);
    return morningMinutes + afternoonMinutes;
}

// æ›´æ–°å€’è®¡æ—¶å’Œè¿›åº¦
function updateCountdown() {
    const now = new Date();

    // æ›´æ–°ä¸Šåˆæ—¶æ®µ
    updatePeriod('morning', now);

    // æ›´æ–°ä¸‹åˆæ—¶æ®µ
    updatePeriod('afternoon', now);

    // æ›´æ–°æ”¶å…¥ç»Ÿè®¡
    updateEarnings(now);
}

// æ›´æ–°å•ä¸ªæ—¶æ®µ
function updatePeriod(period, now) {
    const start = workSchedule[period].start;
    const end = workSchedule[period].end;

    if (!start || !end) return;

    const statusIndicator = document.getElementById(`${period}StatusIndicator`);
    const countdownElement = document.getElementById(`${period}Countdown`);
    const statusTextElement = document.getElementById(`${period}StatusText`);
    const progressElement = document.getElementById(`${period}Progress`);
    const progressBarElement = document.getElementById(`${period}ProgressBar`);

    let status, countdown, progress;

    // ä¿®å¤æ—¶æ®µåˆ¤æ–­é€»è¾‘
    if (period === 'morning') {
        if (now < start) {
            // ä¸Šåˆæœªå¼€å§‹
            status = 'æœªå¼€å§‹';
            countdown = formatCountdown(start - now);
            progress = 0;
            statusIndicator.className = 'status-indicator';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'æœªå¼€å§‹';
        } else if (now >= start && now <= end) {
            // ä¸Šåˆè¿›è¡Œä¸­
            status = 'è¿›è¡Œä¸­';
            countdown = formatCountdown(end - now);
            const elapsed = now - start;
            const total = end - start;
            progress = (elapsed / total) * 100;
            statusIndicator.className = 'status-indicator active';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'è¿›è¡Œä¸­';
        } else {
            // ä¸Šåˆå·²ç»“æŸ
            status = 'å·²å®Œæˆ';
            countdown = '00:00:00';
            progress = 100;
            statusIndicator.className = 'status-indicator finished';
            countdownElement.className = 'countdown-value finished';
            if (statusTextElement) statusTextElement.textContent = 'å·²å®Œæˆ';
        }
    } else if (period === 'afternoon') {
        if (now < start) {
            // ä¸‹åˆæœªå¼€å§‹ - æ˜¾ç¤ºè·ç¦»ä¸‹åˆå¼€å§‹çš„å€’è®¡æ—¶
            status = 'æœªå¼€å§‹';
            countdown = formatCountdown(start - now);
            progress = 0;
            statusIndicator.className = 'status-indicator';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'æœªå¼€å§‹';
            // ä¿®æ”¹æ ‡ç­¾æ˜¾ç¤ºä¸º"è·ç¦»ä¸‹åˆå¼€å§‹"
            const countdownLabel = countdownElement.parentElement.querySelector('.countdown-label');
            if (countdownLabel) {
                countdownLabel.textContent = 'è·ç¦»ä¸‹åˆå¼€å§‹';
            }
        } else if (now >= start && now <= end) {
            // ä¸‹åˆè¿›è¡Œä¸­
            status = 'è¿›è¡Œä¸­';
            countdown = formatCountdown(end - now);
            const elapsed = now - start;
            const total = end - start;
            progress = (elapsed / total) * 100;
            statusIndicator.className = 'status-indicator active';
            countdownElement.className = 'countdown-value';
            if (statusTextElement) statusTextElement.textContent = 'è¿›è¡Œä¸­';
            // æ¢å¤æ ‡ç­¾æ˜¾ç¤ºä¸º"è·ç¦»ä¸‹åˆç»“æŸ"
            const countdownLabel = countdownElement.parentElement.querySelector('.countdown-label');
            if (countdownLabel) {
                countdownLabel.textContent = 'è·ç¦»ä¸‹åˆç»“æŸ';
            }
        } else {
            // ä¸‹åˆå·²ç»“æŸ
            status = 'å·²å®Œæˆ';
            countdown = '00:00:00';
            progress = 100;
            statusIndicator.className = 'status-indicator finished';
            countdownElement.className = 'countdown-value finished';
            if (statusTextElement) statusTextElement.textContent = 'å·²å®Œæˆ';
            // æ¢å¤æ ‡ç­¾æ˜¾ç¤º
            const countdownLabel = countdownElement.parentElement.querySelector('.countdown-label');
            if (countdownLabel) {
                countdownLabel.textContent = 'è·ç¦»ä¸‹åˆç»“æŸ';
            }
        }
    }

    countdownElement.textContent = countdown;
    progressElement.textContent = `${progress.toFixed(1)}%`;
    progressBarElement.style.width = `${progress}%`;
}

// æ›´æ–°æ”¶å…¥ç»Ÿè®¡
function updateEarnings(now) {
    if (workSchedule.dailySalary <= 0) {
        document.getElementById('totalEarnings').textContent = 'Â¥ 0.00';
        document.getElementById('morningEarnings').textContent = 'Â¥ 0.00';
        document.getElementById('afternoonEarnings').textContent = 'Â¥ 0.00';
        return;
    }

    const totalWorkMinutes = getTotalWorkMinutes();
    const minuteRate = workSchedule.dailySalary / totalWorkMinutes;

    // è®¡ç®—ä¸Šåˆæ”¶å…¥
    let morningEarnings = 0;
    const morningStart = workSchedule.morning.start;
    const morningEnd = workSchedule.morning.end;
    if (now > morningStart) {
        const morningWorkedMinutes = Math.min(now - morningStart, morningEnd - morningStart) / (1000 * 60);
        morningEarnings = morningWorkedMinutes * minuteRate;
    }

    // è®¡ç®—ä¸‹åˆæ”¶å…¥
    let afternoonEarnings = 0;
    const afternoonStart = workSchedule.afternoon.start;
    const afternoonEnd = workSchedule.afternoon.end;
    if (now > afternoonStart) {
        const afternoonWorkedMinutes = Math.min(now - afternoonStart, afternoonEnd - afternoonStart) / (1000 * 60);
        afternoonEarnings = afternoonWorkedMinutes * minuteRate;
    }

    const totalEarnings = morningEarnings + afternoonEarnings;

    document.getElementById('totalEarnings').textContent = `Â¥ ${totalEarnings.toFixed(2)}`;
    document.getElementById('morningEarnings').textContent = `Â¥ ${morningEarnings.toFixed(2)}`;
    document.getElementById('afternoonEarnings').textContent = `Â¥ ${afternoonEarnings.toFixed(2)}`;
}

// æ·»åŠ è¾“å…¥éªŒè¯
function addInputValidation() {
    const timeInputs = document.querySelectorAll('.time-input');
    timeInputs.forEach(input => {
        input.addEventListener('input', function() {
            let value = parseInt(this.value);
            if (this.id.includes('Hour')) {
                if (value < 0) this.value = 0;
                if (value > 23) this.value = 23;
            } else {
                if (value < 0) this.value = 0;
                if (value > 59) this.value = 59;
            }
        });
    });

    document.getElementById('dailySalary').addEventListener('input', function() {
        if (parseFloat(this.value) < 0) this.value = 0;
    });
}

// æ·»åŠ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
function addAutoSave() {
    const inputs = [
        'morningStartHour', 'morningStartMin', 'morningEndHour', 'morningEndMin',
        'afternoonStartHour', 'afternoonStartMin', 'afternoonEndHour', 'afternoonEndMin',
        'dailySalary'
    ];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('change', function() {
                // å»¶è¿Ÿä¿å­˜ï¼Œé¿å…é¢‘ç¹ä¿å­˜
                clearTimeout(input.saveTimeout);
                input.saveTimeout = setTimeout(() => {
                    saveSettings();
                    console.log(`${inputId} å·²è‡ªåŠ¨ä¿å­˜`);
                }, 500);
            });
            
            // æ·»åŠ è¾“å…¥æ—¶çš„å®æ—¶åé¦ˆ
            input.addEventListener('input', function() {
                showSaveStatus('ğŸ’¾ æ­£åœ¨ä¿å­˜...', 1000);
            });
        }
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    
    // åŠ è½½ä¿å­˜çš„è®¾ç½®
    const savedSettings = loadSettings();
    
    addInputValidation();
    addAutoSave();

    // åˆå§‹åŒ–å›¾ç‰‡åˆ—è¡¨å’Œæ ·å¼è®¾ç½®
    refreshImageList();
    loadCustomStyles();
    loadSelectedImage();

    // å¦‚æœæœ‰ä¿å­˜çš„è®¾ç½®ï¼Œè‡ªåŠ¨åº”ç”¨
    if (savedSettings) {
        console.log('å‘ç°ä¿å­˜çš„è®¾ç½®ï¼Œè‡ªåŠ¨åº”ç”¨...');
        updateSettings();
    } else {
        console.log('æ²¡æœ‰ä¿å­˜çš„è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        // ä½¿ç”¨é»˜è®¤å€¼å¹¶ä¿å­˜
        saveSettings();
        updateSettings();
    }

    // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
    document.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            updateSettings();
        }
    });
    
    console.log('åˆå§‹åŒ–å®Œæˆ');
});

// è·å–imagesæ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡åˆ—è¡¨
async function loadImageList() {
    try {
        const imageList = [];
        
        // æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
        
        // å¸¸è§çš„å›¾ç‰‡æ–‡ä»¶åæ¨¡å¼ï¼ˆæ›´å…¨é¢çš„åˆ—è¡¨ï¼‰
        const commonNames = [
            'bg', 'background', 'wallpaper', 'backdrop', 'cover',
            'image', 'img', 'photo', 'pic', 'picture',
            'èƒŒæ™¯', 'å£çº¸', 'å›¾ç‰‡', 'å›¾åƒ',
            // æ•°å­—åºåˆ—
            '1', '2', '3', '4', '5', '6', '7', '8', '9', '10',
            '01', '02', '03', '04', '05', '06', '07', '08', '09',
            // å¸¦å‰ç¼€çš„æ•°å­—
            'image1', 'image2', 'image3', 'img1', 'img2', 'img3',
            'pic1', 'pic2', 'pic3', 'photo1', 'photo2', 'photo3',
            'bg1', 'bg2', 'bg3', 'background1', 'background2', 'background3'
        ];
        
        console.log('å¼€å§‹æ‰«æimagesæ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡...');
        
        // è·å–ç”¨æˆ·è‡ªå®šä¹‰æ·»åŠ çš„å›¾ç‰‡æ–‡ä»¶å
        const customImages = getCustomImageNames();
        if (customImages.length > 0) {
            console.log('åŒ…å«ç”¨æˆ·è‡ªå®šä¹‰å›¾ç‰‡:', customImages);
            commonNames.push(...customImages);
        }
        
        // å¹¶å‘æ£€æµ‹æ‰€æœ‰å¯èƒ½çš„å›¾ç‰‡æ–‡ä»¶
        const promises = [];
        
        for (const extension of imageExtensions) {
            for (const name of commonNames) {
                const imageName = `${name}.${extension}`;
                const imagePath = `images/${imageName}`;
                
                // åˆ›å»ºæ£€æµ‹Promise
                const promise = testImageExists(imagePath).then(exists => {
                    if (exists) {
                        return {
                            name: imageName,
                            path: imagePath,
                            basename: name,
                            extension: extension
                        };
                    }
                    return null;
                });
                
                promises.push(promise);
            }
        }
        
        // ç­‰å¾…æ‰€æœ‰æ£€æµ‹å®Œæˆ
        const results = await Promise.all(promises);
        
        // è¿‡æ»¤å‡ºå­˜åœ¨çš„å›¾ç‰‡
        const foundImages = results.filter(result => result !== null);
        
        // æŒ‰æ–‡ä»¶åæ’åº
        foundImages.sort((a, b) => {
            // ä¼˜å…ˆæ˜¾ç¤ºå¸¸è§çš„èƒŒæ™¯å›¾ç‰‡åç§°
            const priorityNames = ['bg', 'background', 'wallpaper'];
            const aPriority = priorityNames.indexOf(a.basename);
            const bPriority = priorityNames.indexOf(b.basename);
            
            if (aPriority !== -1 && bPriority === -1) return -1;
            if (aPriority === -1 && bPriority !== -1) return 1;
            if (aPriority !== -1 && bPriority !== -1) return aPriority - bPriority;
            
            // å…¶ä»–æŒ‰å­—æ¯é¡ºåºæ’åº
            return a.name.localeCompare(b.name);
        });
        
        console.log(`æ‰«æå®Œæˆï¼Œæ‰¾åˆ° ${foundImages.length} å¼ å›¾ç‰‡:`, foundImages.map(img => img.name));
        
        return foundImages;
        
    } catch (error) {
        console.error('åŠ è½½å›¾ç‰‡åˆ—è¡¨æ—¶å‡ºé”™:', error);
        return [];
    }
}

// æµ‹è¯•å›¾ç‰‡æ˜¯å¦å­˜åœ¨çš„è¾…åŠ©å‡½æ•°
function testImageExists(imagePath) {
    return new Promise((resolve) => {
        const img = new Image();
        let resolved = false;
        
        const resolveOnce = (result) => {
            if (!resolved) {
                resolved = true;
                resolve(result);
            }
        };
        
        img.onload = () => {
            // ç¡®ä¿å›¾ç‰‡çœŸçš„åŠ è½½æˆåŠŸï¼ˆæœ‰äº›æƒ…å†µä¸‹onloadä¼šè¢«é”™è¯¯è§¦å‘ï¼‰
            if (img.naturalWidth > 0 && img.naturalHeight > 0) {
                resolveOnce(true);
            } else {
                resolveOnce(false);
            }
        };
        
        img.onerror = () => resolveOnce(false);
        img.onabort = () => resolveOnce(false);
        
        // è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´æé«˜æ‰«æé€Ÿåº¦
        setTimeout(() => resolveOnce(false), 1500);
        
        // å¼€å§‹åŠ è½½å›¾ç‰‡
        img.src = imagePath;
    });
}

// åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
async function refreshImageList() {
    const select = document.getElementById('backgroundImageSelect');
    if (!select) return;
    
    const currentValue = select.value;
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹
    select.innerHTML = '<option value="">è¯·é€‰æ‹©å›¾ç‰‡</option>';
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingOption = document.createElement('option');
        loadingOption.value = "";
        loadingOption.textContent = "æ­£åœ¨åŠ è½½å›¾ç‰‡åˆ—è¡¨...";
        loadingOption.disabled = true;
        select.appendChild(loadingOption);
        
        const imageList = await loadImageList();
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        select.innerHTML = '<option value="">è¯·é€‰æ‹©å›¾ç‰‡</option>';
        
        if (imageList.length > 0) {
            imageList.forEach(image => {
                const option = document.createElement('option');
                option.value = image.path;
                option.textContent = image.name;
                select.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼
            if (currentValue && imageList.some(img => img.path === currentValue)) {
                select.value = currentValue;
            }
            
            console.log(`æˆåŠŸåŠ è½½ ${imageList.length} å¼ å›¾ç‰‡:`, imageList);
        } else {
            // æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ—¶çš„æç¤º
            const noImageOption = document.createElement('option');
            noImageOption.value = "";
            noImageOption.textContent = "æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶";
            noImageOption.disabled = true;
            select.appendChild(noImageOption);
            
            console.log('æœªåœ¨imagesæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶');
        }
    } catch (error) {
        console.error('åˆ·æ–°å›¾ç‰‡åˆ—è¡¨æ—¶å‡ºé”™:', error);
        // é”™è¯¯æ—¶çš„æç¤º
        select.innerHTML = '<option value="">åŠ è½½å›¾ç‰‡åˆ—è¡¨å¤±è´¥</option>';
    }
}

// å¤„ç†å›¾ç‰‡é€‰æ‹©
function handleImageSelect(select) {
    const imagePath = select.value;
    if (imagePath) {
        document.getElementById('backgroundImage').value = imagePath;
        localStorage.setItem('selectedBackgroundImage', imagePath);
        applyStyles();
    }
}

// åˆ‡æ¢èƒŒæ™¯é€‰é¡¹æ˜¾ç¤º
function toggleBackgroundOptions() {
    const backgroundType = document.getElementById('backgroundType').value;
    const gradientOptions = document.getElementById('gradientOptions');
    const solidOptions = document.getElementById('solidOptions');
    const imageOptions = document.getElementById('imageOptions');
    
    gradientOptions.style.display = 'none';
    solidOptions.style.display = 'none';
    imageOptions.style.display = 'none';
    
    switch(backgroundType) {
        case 'gradient':
            gradientOptions.style.display = 'block';
            break;
        case 'solid':
            solidOptions.style.display = 'block';
            break;
        case 'image':
            imageOptions.style.display = 'block';
            break;
    }
    
    applyStyles();
}

// åŠ è½½ä¿å­˜çš„å›¾ç‰‡é€‰æ‹©
function loadSelectedImage() {
    try {
        const selectedImage = localStorage.getItem('selectedBackgroundImage');
        if (selectedImage) {
            document.getElementById('backgroundImage').value = selectedImage;
            const select = document.getElementById('backgroundImageSelect');
            if (select) {
                const option = Array.from(select.options).find(opt => opt.value === selectedImage);
                if (option) {
                    select.value = selectedImage;
                }
            }
        }
    } catch (error) {
        console.error('åŠ è½½é€‰æ‹©çš„å›¾ç‰‡æ—¶å‡ºé”™:', error);
    }
}

// åˆ‡æ¢æ ·å¼é¢æ¿æ˜¾ç¤º
function toggleStylePanel() {
    const panel = document.getElementById('stylePanel');
    if (panel) {
        if (panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'block';
        } else {
            panel.style.display = 'none';
        }
    }
}

// å…³é—­æ ·å¼é¢æ¿
function closeStylePanel(event) {
    if (event) {
        event.stopPropagation();
    }
    const panel = document.getElementById('stylePanel');
    if (panel) {
        panel.style.display = 'none';
    }
}

// æ‹–æ‹½åŠŸèƒ½
let isDragging = false;
let dragOffset = { x: 0, y: 0 };

function startDrag(event) {
    isDragging = true;
    const panel = document.getElementById('stylePanel');
    const rect = panel.getBoundingClientRect();
    dragOffset.x = event.clientX - rect.left;
    dragOffset.y = event.clientY - rect.top;
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
}

function drag(event) {
    if (!isDragging) return;
    
    const panel = document.getElementById('stylePanel');
    panel.style.left = (event.clientX - dragOffset.x) + 'px';
    panel.style.top = (event.clientY - dragOffset.y) + 'px';
    panel.style.transform = 'none';
}

function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
}

// åº”ç”¨æ ·å¼
function applyStyles() {
    try {
        const fontSize = document.getElementById('fontSize')?.value || 'medium';
        const fontFamily = document.getElementById('fontFamily')?.value || 'default';
        const backgroundType = document.getElementById('backgroundType')?.value || 'gradient';
        
        // åº”ç”¨å­—ä½“å¤§å°
        const fontSizeMap = {
            'small': '0.85em',
            'medium': '1em',
            'large': '1.15em',
            'xlarge': '1.3em'
        };
        document.body.style.fontSize = fontSizeMap[fontSize];
        
        // åº”ç”¨å­—ä½“æ ·å¼
        const fontFamilyMap = {
            'default': "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
            'serif': 'serif',
            'sans-serif': 'sans-serif',
            'monospace': 'monospace',
            'cursive': 'cursive'
        };
        document.body.style.fontFamily = fontFamilyMap[fontFamily];
        
        // åº”ç”¨èƒŒæ™¯
        switch(backgroundType) {
            case 'gradient':
                const color1 = document.getElementById('gradientColor1')?.value || '#e68aff';
                const color2 = document.getElementById('gradientColor2')?.value || '#0984e3';
                const color3 = document.getElementById('gradientColor3')?.value || '#6c5ce7';
                document.body.style.background = `linear-gradient(135deg, ${color1} 0%, ${color2} 50%, ${color3} 100%)`;
                break;
            case 'solid':
                const solidColor = document.getElementById('solidColor')?.value || '#6c5ce7';
                document.body.style.background = solidColor;
                break;
            case 'image':
                const backgroundImage = document.getElementById('backgroundImage')?.value;
                if (backgroundImage) {
                    document.body.style.background = `url('${backgroundImage}') center/cover no-repeat`;
                }
                break;
        }
        
        // åº”ç”¨æ–‡å­—é¢œè‰²
        const titleColor = document.getElementById('titleColor')?.value || '#ffffff';
        const earningsColor = document.getElementById('earningsColor')?.value || '#d22eff';
        const countdownColor = document.getElementById('countdownColor')?.value || '#ffffff';
        const progressColor = document.getElementById('progressColor')?.value || '#ffffff';
        const statusColor = document.getElementById('statusColor')?.value || '#ffffff';
        const settingLabelColor = document.getElementById('settingLabelColor')?.value || '#e68aff';
        
        const titleElements = document.querySelectorAll('.title, .period-title');
        titleElements.forEach(el => el.style.color = titleColor);
        
        const earningsElements = document.querySelectorAll('.earnings-value, .earnings-item-value');
        earningsElements.forEach(el => el.style.color = earningsColor);
        
        const countdownElements = document.querySelectorAll('.countdown-value');
        countdownElements.forEach(el => el.style.color = countdownColor);
        
        const progressElements = document.querySelectorAll('.progress-header span:last-child');
        progressElements.forEach(el => el.style.color = progressColor);
        
        const statusElements = document.querySelectorAll('.countdown-value, .earnings-item-label');
        statusElements.forEach(el => el.style.color = statusColor);
        
        const settingLabelElements = document.querySelectorAll('.time-setting h3, .salary-setting h3, .earnings-title, .style-section h5');
        settingLabelElements.forEach(el => el.style.color = settingLabelColor);
        
    } catch (error) {
        console.error('åº”ç”¨æ ·å¼æ—¶å‡ºé”™:', error);
    }
}

// ä¿å­˜è‡ªå®šä¹‰æ ·å¼
function saveCustomStyles() {
    try {
        const styles = {
            fontSize: document.getElementById('fontSize')?.value,
            fontFamily: document.getElementById('fontFamily')?.value,
            backgroundType: document.getElementById('backgroundType')?.value,
            gradientColor1: document.getElementById('gradientColor1')?.value,
            gradientColor2: document.getElementById('gradientColor2')?.value,
            gradientColor3: document.getElementById('gradientColor3')?.value,
            solidColor: document.getElementById('solidColor')?.value,
            backgroundImage: document.getElementById('backgroundImage')?.value,
            titleColor: document.getElementById('titleColor')?.value,
            earningsColor: document.getElementById('earningsColor')?.value,
            countdownColor: document.getElementById('countdownColor')?.value,
            progressColor: document.getElementById('progressColor')?.value,
            statusColor: document.getElementById('statusColor')?.value,
            settingLabelColor: document.getElementById('settingLabelColor')?.value
        };
        
        localStorage.setItem('customStyles', JSON.stringify(styles));
        console.log('è‡ªå®šä¹‰æ ·å¼å·²ä¿å­˜:', styles);
        alert('æ ·å¼è®¾ç½®å·²ä¿å­˜ï¼');
    } catch (error) {
        console.error('ä¿å­˜æ ·å¼æ—¶å‡ºé”™:', error);
        alert('ä¿å­˜æ ·å¼å¤±è´¥ï¼');
    }
}

// é‡ç½®æ ·å¼
function resetStyles() {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ ·å¼è®¾ç½®å—ï¼Ÿ')) {
        localStorage.removeItem('customStyles');
        localStorage.removeItem('selectedBackgroundImage');
        
        // é‡ç½®ä¸ºé»˜è®¤å€¼
        if (document.getElementById('fontSize')) document.getElementById('fontSize').value = 'medium';
        if (document.getElementById('fontFamily')) document.getElementById('fontFamily').value = 'default';
        if (document.getElementById('backgroundType')) document.getElementById('backgroundType').value = 'gradient';
        if (document.getElementById('gradientColor1')) document.getElementById('gradientColor1').value = '#e68aff';
        if (document.getElementById('gradientColor2')) document.getElementById('gradientColor2').value = '#0984e3';
        if (document.getElementById('gradientColor3')) document.getElementById('gradientColor3').value = '#6c5ce7';
        if (document.getElementById('solidColor')) document.getElementById('solidColor').value = '#6c5ce7';
        if (document.getElementById('backgroundImage')) document.getElementById('backgroundImage').value = '';
        if (document.getElementById('backgroundImageSelect')) document.getElementById('backgroundImageSelect').value = '';
        if (document.getElementById('titleColor')) document.getElementById('titleColor').value = '#ffffff';
        if (document.getElementById('earningsColor')) document.getElementById('earningsColor').value = '#d22eff';
        if (document.getElementById('countdownColor')) document.getElementById('countdownColor').value = '#ffffff';
        if (document.getElementById('progressColor')) document.getElementById('progressColor').value = '#ffffff';
        if (document.getElementById('statusColor')) document.getElementById('statusColor').value = '#ffffff';
        if (document.getElementById('settingLabelColor')) document.getElementById('settingLabelColor').value = '#e68aff';
        
        toggleBackgroundOptions();
        applyStyles();
        alert('æ ·å¼å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®ï¼');
    }
}

// åŠ è½½è‡ªå®šä¹‰æ ·å¼
function loadCustomStyles() {
    try {
        const savedStyles = localStorage.getItem('customStyles');
        if (savedStyles) {
            const styles = JSON.parse(savedStyles);
            
            // æ¢å¤æ ·å¼è®¾ç½®
            if (styles.fontSize && document.getElementById('fontSize')) document.getElementById('fontSize').value = styles.fontSize;
            if (styles.fontFamily && document.getElementById('fontFamily')) document.getElementById('fontFamily').value = styles.fontFamily;
            if (styles.backgroundType && document.getElementById('backgroundType')) document.getElementById('backgroundType').value = styles.backgroundType;
            if (styles.gradientColor1 && document.getElementById('gradientColor1')) document.getElementById('gradientColor1').value = styles.gradientColor1;
            if (styles.gradientColor2 && document.getElementById('gradientColor2')) document.getElementById('gradientColor2').value = styles.gradientColor2;
            if (styles.gradientColor3 && document.getElementById('gradientColor3')) document.getElementById('gradientColor3').value = styles.gradientColor3;
            if (styles.solidColor && document.getElementById('solidColor')) document.getElementById('solidColor').value = styles.solidColor;
            if (styles.backgroundImage && document.getElementById('backgroundImage')) document.getElementById('backgroundImage').value = styles.backgroundImage;
            if (styles.titleColor && document.getElementById('titleColor')) document.getElementById('titleColor').value = styles.titleColor;
            if (styles.earningsColor && document.getElementById('earningsColor')) document.getElementById('earningsColor').value = styles.earningsColor;
            if (styles.countdownColor && document.getElementById('countdownColor')) document.getElementById('countdownColor').value = styles.countdownColor;
            if (styles.progressColor && document.getElementById('progressColor')) document.getElementById('progressColor').value = styles.progressColor;
            if (styles.statusColor && document.getElementById('statusColor')) document.getElementById('statusColor').value = styles.statusColor;
            if (styles.settingLabelColor && document.getElementById('settingLabelColor')) document.getElementById('settingLabelColor').value = styles.settingLabelColor;
            
            toggleBackgroundOptions();
            applyStyles();
            
            console.log('è‡ªå®šä¹‰æ ·å¼å·²åŠ è½½:', styles);
        }
    } catch (error) {
        console.error('åŠ è½½è‡ªå®šä¹‰æ ·å¼æ—¶å‡ºé”™:', error);
    }
}

// è·å–è‡ªå®šä¹‰å›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨
function getCustomImageNames() {
    try {
        const saved = localStorage.getItem('customImageNames');
        return saved ? JSON.parse(saved) : [];
    } catch (error) {
        console.error('è·å–è‡ªå®šä¹‰å›¾ç‰‡åˆ—è¡¨æ—¶å‡ºé”™:', error);
        return [];
    }
}

// ä¿å­˜è‡ªå®šä¹‰å›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨
function saveCustomImageNames(names) {
    try {
        localStorage.setItem('customImageNames', JSON.stringify(names));
    } catch (error) {
        console.error('ä¿å­˜è‡ªå®šä¹‰å›¾ç‰‡åˆ—è¡¨æ—¶å‡ºé”™:', error);
    }
}

// æ·»åŠ è‡ªå®šä¹‰å›¾ç‰‡æ–‡ä»¶å
function addCustomImage() {
    const input = document.getElementById('customImageName');
    const imageName = input.value.trim();
    
    if (!imageName) {
        alert('è¯·è¾“å…¥å›¾ç‰‡æ–‡ä»¶åï¼');
        return;
    }
    
    // éªŒè¯æ–‡ä»¶åæ ¼å¼
    const validExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
    const extension = imageName.split('.').pop()?.toLowerCase();
    
    if (!extension || !validExtensions.includes(extension)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶åï¼\næ”¯æŒçš„æ ¼å¼: ' + validExtensions.join(', '));
        return;
    }
    
    // ç§»é™¤æ‰©å±•åï¼Œåªä¿å­˜åŸºç¡€åç§°
    const baseName = imageName.replace(/\.[^/.]+$/, '');
    
    // è·å–ç°æœ‰çš„è‡ªå®šä¹‰å›¾ç‰‡åˆ—è¡¨
    const customImages = getCustomImageNames();
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (customImages.includes(baseName)) {
        alert('è¯¥å›¾ç‰‡æ–‡ä»¶åå·²å­˜åœ¨ï¼');
        return;
    }
    
    // æ·»åŠ åˆ°åˆ—è¡¨
    customImages.push(baseName);
    saveCustomImageNames(customImages);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    // åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
    refreshImageList();
    
    alert(`å·²æ·»åŠ å›¾ç‰‡æ–‡ä»¶å: ${imageName}\næ­£åœ¨é‡æ–°æ‰«æå›¾ç‰‡åˆ—è¡¨...`);
}

// ç§»é™¤è‡ªå®šä¹‰å›¾ç‰‡æ–‡ä»¶å
function removeCustomImage(baseName) {
    if (confirm(`ç¡®å®šè¦ç§»é™¤è‡ªå®šä¹‰å›¾ç‰‡æ–‡ä»¶å "${baseName}" å—ï¼Ÿ`)) {
        const customImages = getCustomImageNames();
        const index = customImages.indexOf(baseName);
        if (index > -1) {
            customImages.splice(index, 1);
            saveCustomImageNames(customImages);
            refreshImageList();
        }
    }
}

// æ˜¾ç¤ºè‡ªå®šä¹‰å›¾ç‰‡ç®¡ç†ç•Œé¢
function showCustomImageManager() {
    const customImages = getCustomImageNames();
    if (customImages.length === 0) {
        alert('æš‚æ— è‡ªå®šä¹‰å›¾ç‰‡æ–‡ä»¶å');
        return;
    }
    
    const message = 'è‡ªå®šä¹‰å›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨ï¼š\n' + 
                   customImages.map((name, index) => `${index + 1}. ${name}`).join('\n') +
                   '\n\nè¦ç§»é™¤æŸä¸ªæ–‡ä»¶åå—ï¼Ÿ';
    
    if (confirm(message)) {
        const nameToRemove = prompt('è¯·è¾“å…¥è¦ç§»é™¤çš„æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰:');
        if (nameToRemove && customImages.includes(nameToRemove.trim())) {
            removeCustomImage(nameToRemove.trim());
        }
    }
}
</script>
</html>ist = await loadImageList();
        
        // ç§»é™¤åŠ è½½çŠ¶æ€
        select.innerHTML = '<option value="">è¯·é€‰æ‹©å›¾ç‰‡</option>';
        
        if (imageList.length > 0) {
            imageList.forEach(image => {
                const option = document.createElement('option');
                option.value = image.path;
                option.textContent = image.name;
                select.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼
            if (currentValue && imageList.some(img => img.path === currentValue)) {
                select.value = currentValue;
            }
            
            console.log(`æˆåŠŸåŠ è½½ ${imageList.length} å¼ å›¾ç‰‡:`, imageList);
        } else {
            // æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ—¶çš„æç¤º
            const noImageOption = document.createElement('option');
            noImageOption.value = "";
            noImageOption.textContent = "æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶";
            noImageOption.disabled = true;
            select.appendChild(noImageOption);
            
            console.log('æœªåœ¨imagesæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶');
        }
    } catch (error) {
        console.error('åˆ·æ–°å›¾ç‰‡åˆ—è¡¨æ—¶å‡ºé”™:', error);
        // é”™è¯¯æ—¶çš„æç¤º
        select.innerHTML = '<option value="">åŠ è½½å›¾ç‰‡åˆ—è¡¨å¤±è´¥</option>';
    }
}nsole.log(`æ‰¾åˆ° ${imageList.length} ä¸ªå›¾ç‰‡æ–‡ä»¶`);
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶';
            option.disabled = true;
            select.appendChild(option);
            console.log('imagesæ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶');
        }
    } catch (error) {
        console.error('åˆ·æ–°å›¾ç‰‡åˆ—è¡¨å¤±è´¥:', error);
    }
}

// å¤„ç†å›¾ç‰‡é€‰æ‹©
function handleImageSelect(select) {
    const selectedPath = select.value;
    if (selectedPath) {
        customStyles.backgroundImage = selectedPath;
        // æ¸…ç©ºURLè¾“å…¥æ¡†
        const urlInput = document.getElementById('backgroundImage');
        if (urlInput) urlInput.value = '';
        console.log('é€‰æ‹©äº†å›¾ç‰‡:', selectedPath);
        
        // ä¿å­˜é€‰æ‹©çš„å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨
        saveSelectedImage(selectedPath);
        
        // åº”ç”¨æ ·å¼
        applyStyles();
    }
}

// ä¿å­˜é€‰æ‹©çš„å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨
function saveSelectedImage(imagePath) {
    try {
        localStorage.setItem('selectedBackgroundImage', imagePath);
        console.log('å›¾ç‰‡é€‰æ‹©å·²ä¿å­˜:', imagePath);
    } catch (error) {
        console.error('ä¿å­˜å›¾ç‰‡é€‰æ‹©æ—¶å‡ºé”™:', error);
    }
}

// åŠ è½½ä¿å­˜çš„å›¾ç‰‡é€‰æ‹©
function loadSelectedImage() {
    try {
        const savedImage = localStorage.getItem('selectedBackgroundImage');
        if (savedImage) {
            const select = document.getElementById('backgroundImageSelect');
            if (select) {
                // éœ€è¦ç­‰å¾…å›¾ç‰‡åˆ—è¡¨åŠ è½½å®Œæˆåå†è®¾ç½®é€‰æ‹©
                setTimeout(() => {
                    if (select.querySelector(`option[value="${savedImage}"]`)) {
                        select.value = savedImage;
                        customStyles.backgroundImage = savedImage;
                        console.log('æ¢å¤ä¿å­˜çš„å›¾ç‰‡é€‰æ‹©:', savedImage);
                    } else {
                        console.log('ä¿å­˜çš„å›¾ç‰‡æ–‡ä»¶å·²ä¸å­˜åœ¨:', savedImage);
                        localStorage.removeItem('selectedBackgroundImage');
                    }
                }, 500);
            }
        }
    } catch (error) {
        console.error('åŠ è½½å›¾ç‰‡é€‰æ‹©æ—¶å‡ºé”™:', error);
    }
}

// æ ·å¼è®¾ç½®åŠŸèƒ½
let customStyles = {
    fontSize: 'medium',
    fontFamily: 'default',
    backgroundType: 'gradient',
    gradientColor1: '#e68aff',
    gradientColor2: '#0984e3',
    gradientColor3: '#6c5ce7',
    solidColor: '#6c5ce7',
    backgroundImage: '',
    titleColor: '#ffffff',
    earningsColor: '#d22eff',
    countdownColor: '#ffffff',
    progressColor: '#ffffff',
    statusColor: '#ffffff',
    settingLabelColor: '#e68aff'
};

// åˆ‡æ¢æ ·å¼è®¾ç½®é¢æ¿æ˜¾ç¤º
function toggleStylePanel() {
    const panel = document.getElementById('stylePanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// å…³é—­æ ·å¼è®¾ç½®é¢æ¿
function closeStylePanel(event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘æ‹–åŠ¨
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const panel = document.getElementById('stylePanel');
    panel.style.display = 'none';
    
    // æ·»åŠ ä¸€ä¸ªå°åŠ¨ç”»æ•ˆæœ
    panel.style.opacity = '0';
    setTimeout(() => {
        panel.style.opacity = '1';
    }, 100);
}

// æ‹–åŠ¨åŠŸèƒ½å˜é‡
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

// å¼€å§‹æ‹–åŠ¨
function startDrag(e) {
    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å…³é—­æŒ‰é’®
    if (e.target.onclick && e.target.onclick.toString().includes('closeStylePanel')) {
        return;
    }
    
    const panel = document.getElementById('stylePanel');
    const rect = panel.getBoundingClientRect();
    
    isDragging = true;
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    
    // æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
    
    // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
    e.preventDefault();
}

// æ‹–åŠ¨è¿‡ç¨‹
function drag(e) {
    if (!isDragging) return;
    
    const panel = document.getElementById('stylePanel');
    const newX = e.clientX - dragOffsetX;
    const newY = e.clientY - dragOffsetY;
    
    // é™åˆ¶åœ¨çª—å£èŒƒå›´å†…
    const maxX = window.innerWidth - panel.offsetWidth;
    const maxY = window.innerHeight - panel.offsetHeight;
    
    const constrainedX = Math.max(0, Math.min(newX, maxX));
    const constrainedY = Math.max(0, Math.min(newY, maxY));
    
    panel.style.left = constrainedX + 'px';
    panel.style.top = constrainedY + 'px';
    panel.style.transform = 'none'; // ç§»é™¤å±…ä¸­å˜æ¢
}

// åœæ­¢æ‹–åŠ¨
function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
}

// åˆ‡æ¢èƒŒæ™¯é€‰é¡¹æ˜¾ç¤º
function toggleBackgroundOptions() {
    const backgroundType = document.getElementById('backgroundType').value;
    const gradientOptions = document.getElementById('gradientOptions');
    const solidOptions = document.getElementById('solidOptions');
    const imageOptions = document.getElementById('imageOptions');

    gradientOptions.style.display = backgroundType === 'gradient' ? 'block' : 'none';
    solidOptions.style.display = backgroundType === 'solid' ? 'block' : 'none';
    imageOptions.style.display = backgroundType === 'image' ? 'block' : 'none';

    // ç«‹å³åº”ç”¨èƒŒæ™¯æ›´æ”¹
    applyStyles();
}

// å¤„ç†æœ¬åœ°å›¾ç‰‡ä¸Šä¼ 
function handleImageUpload(input) {
    const file = input.files[0];
    if (file) {
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
        if (file.size > 5 * 1024 * 1024) {
            alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡ï¼');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // ç¡®ä¿å›¾ç‰‡æ•°æ®æ­£ç¡®è¯»å–
            const imageData = e.target.result;
            console.log('å›¾ç‰‡æ•°æ®é•¿åº¦:', imageData.length);
            console.log('å›¾ç‰‡æ•°æ®å‰100å­—ç¬¦:', imageData.substring(0, 100));
            
            // æ›´æ–°æ ·å¼è®¾ç½®
            customStyles.backgroundImage = imageData;
            customStyles.backgroundType = 'image';
            
            // æ›´æ–°ç•Œé¢æ§ä»¶
            document.getElementById('backgroundType').value = 'image';
            document.getElementById('backgroundImage').value = 'æœ¬åœ°å›¾ç‰‡å·²é€‰æ‹©';
            
            // åˆ‡æ¢æ˜¾ç¤ºé€‰é¡¹
            toggleBackgroundOptions();
            
            // ç«‹å³åº”ç”¨æ ·å¼
            applyStylesForced();
            
            showSaveStatus('ğŸ“ æœ¬åœ°å›¾ç‰‡å·²åŠ è½½', 2000);
        };
        
        reader.onerror = function() {
            alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
        };
        
        reader.readAsDataURL(file);
    }
}

// éªŒè¯å›¾ç‰‡é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
function validateImageUrl(url) {
    return new Promise((resolve) => {
        if (!url || url === 'æœ¬åœ°å›¾ç‰‡å·²é€‰æ‹©') {
            resolve(true);
            return;
        }
        
        const img = new Image();
        const timeoutId = setTimeout(() => {
            resolve(false);
        }, 5000); // 5ç§’è¶…æ—¶
        
        img.onload = function() {
            clearTimeout(timeoutId);
            resolve(true);
        };
        
        img.onerror = function() {
            clearTimeout(timeoutId);
            resolve(false);
        };
        
        img.src = url;
    });
}

// åº”ç”¨æ ·å¼è®¾ç½®
function applyStyles() {
    // è·å–å½“å‰è®¾ç½®å€¼
    customStyles.fontSize = document.getElementById('fontSize').value;
    customStyles.fontFamily = document.getElementById('fontFamily').value;
    customStyles.backgroundType = document.getElementById('backgroundType').value;
    customStyles.gradientColor1 = document.getElementById('gradientColor1').value;
    customStyles.gradientColor2 = document.getElementById('gradientColor2').value;
    customStyles.gradientColor3 = document.getElementById('gradientColor3').value;
    customStyles.solidColor = document.getElementById('solidColor').value;
    
    // å¤„ç†èƒŒæ™¯å›¾ç‰‡
    const backgroundImageInput = document.getElementById('backgroundImage').value;
    if (backgroundImageInput !== customStyles.backgroundImage) {
        customStyles.backgroundImage = backgroundImageInput;
    }
    
    customStyles.titleColor = document.getElementById('titleColor').value;
    customStyles.earningsColor = document.getElementById('earningsColor').value;
    customStyles.countdownColor = document.getElementById('countdownColor').value;
    customStyles.progressColor = document.getElementById('progressColor').value;
    customStyles.statusColor = document.getElementById('statusColor').value;
    customStyles.settingLabelColor = document.getElementById('settingLabelColor').value;

    // åˆ›å»ºæˆ–æ›´æ–°åŠ¨æ€æ ·å¼
    let styleElement = document.getElementById('custom-styles');
    if (!styleElement) {
        styleElement = document.createElement('style');
        styleElement.id = 'custom-styles';
        document.head.appendChild(styleElement);
    }

    // æ„å»ºå­—ä½“å¤§å°æ˜ å°„
    const fontSizeMap = {
        small: '0.8',
        medium: '1',
        large: '1.2',
        xlarge: '1.5'
    };

    // æ„å»ºå­—ä½“å®¶æ—æ˜ å°„
    const fontFamilyMap = {
        default: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
        serif: "'SimSun', serif",
        'sans-serif': "'SimHei', 'Microsoft YaHei', sans-serif",
        monospace: "'Courier New', monospace",
        cursive: "'KaiTi', cursive"
    };

    // æ„å»ºèƒŒæ™¯æ ·å¼
    let backgroundStyle = '';
    switch (customStyles.backgroundType) {
        case 'gradient':
            backgroundStyle = `linear-gradient(135deg, ${customStyles.gradientColor1} 0%, ${customStyles.gradientColor2} 50%, ${customStyles.gradientColor3} 100%)`;
            break;
        case 'solid':
            backgroundStyle = customStyles.solidColor;
            break;
        case 'image':
            if (customStyles.backgroundImage) {
                // å¦‚æœæ˜¯ç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼ŒéªŒè¯å…¶æœ‰æ•ˆæ€§
                if (customStyles.backgroundImage.startsWith('http') && customStyles.backgroundImage !== 'æœ¬åœ°å›¾ç‰‡å·²é€‰æ‹©') {
                    validateImageUrl(customStyles.backgroundImage).then(isValid => {
                        if (!isValid) {
                            alert('å›¾ç‰‡é“¾æ¥æ— æ•ˆæˆ–åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®ï¼\n\nå»ºè®®ï¼š\n1. ç¡®ä¿å›¾ç‰‡é“¾æ¥å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®\n2. å°è¯•ä½¿ç”¨æœ¬åœ°å›¾ç‰‡\n3. æ£€æŸ¥ç½‘ç»œè¿æ¥');
                            // å›é€€åˆ°æ¸å˜èƒŒæ™¯
                            document.getElementById('backgroundType').value = 'gradient';
                            customStyles.backgroundType = 'gradient';
                            document.getElementById('backgroundImage').value = '';
                            customStyles.backgroundImage = '';
                            toggleBackgroundOptions();
                            applyStyles();
                        }
                    });
                }
                backgroundStyle = `url('${customStyles.backgroundImage}') center/cover no-repeat fixed`;
            } else {
                backgroundStyle = `linear-gradient(135deg, ${customStyles.gradientColor1} 0%, ${customStyles.gradientColor2} 50%, ${customStyles.gradientColor3} 100%)`;
            }
            break;
    }

    const dynamicCSS = `
        body {
            background: ${backgroundStyle} !important;
            font-family: ${fontFamilyMap[customStyles.fontFamily]} !important;
            font-size: calc(${fontSizeMap[customStyles.fontSize]}rem * var(--base-font-size, 1)) !important;
        }
        
        .title, .subtitle, .period-title {
            color: ${customStyles.titleColor} !important;
        }
        
        .earnings-title, .earnings-value, .earnings-item-value {
            color: ${customStyles.earningsColor} !important;
        }
        
        .countdown-value {
            color: ${customStyles.countdownColor} !important;
        }
        
        .progress-header span {
            color: ${customStyles.progressColor} !important;
        }
        
        #morningStatusText, #afternoonStatusText, .countdown-label {
            color: ${customStyles.statusColor} !important;
        }
        
        .time-setting h3, .earnings-title, .style-section h5 {
            color: ${customStyles.settingLabelColor} !important;
        }
        
        /* å­—ä½“å¤§å°è°ƒæ•´ */
        .title {
            font-size: calc(1.8rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .subtitle {
            font-size: calc(0.9rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .countdown-value {
            font-size: calc(1.3rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .earnings-value {
            font-size: calc(1.8rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
        
        .period-title {
            font-size: calc(1.2rem * ${fontSizeMap[customStyles.fontSize]}) !important;
        }
    `;

    styleElement.textContent = dynamicCSS;
}

// å¼ºåˆ¶åº”ç”¨æ ·å¼ï¼ˆç”¨äºæœ¬åœ°å›¾ç‰‡ä¸Šä¼ ï¼‰
function applyStylesForced() {
    console.log('å¼ºåˆ¶åº”ç”¨æ ·å¼ï¼ŒèƒŒæ™¯ç±»å‹:', customStyles.backgroundType);
    console.log('èƒŒæ™¯å›¾ç‰‡æ•°æ®:', customStyles.backgroundImage ? customStyles.backgroundImage.substring(0, 50) + '...' : 'null');
    
    // ç›´æ¥è®¾ç½®bodyèƒŒæ™¯
    if (customStyles.backgroundType === 'image' && customStyles.backgroundImage) {
        const backgroundStyle = `url('${customStyles.backgroundImage}') center/cover no-repeat fixed`;
        document.body.style.background = backgroundStyle;
        document.body.style.backgroundAttachment = 'fixed';
        console.log('ç›´æ¥åº”ç”¨èƒŒæ™¯å›¾ç‰‡:', backgroundStyle.substring(0, 100) + '...');
    } else {
        // è°ƒç”¨æ­£å¸¸çš„åº”ç”¨æ ·å¼å‡½æ•°
        applyStyles();
    }
}

// ä¿å­˜è‡ªå®šä¹‰æ ·å¼
function saveCustomStyles() {
    localStorage.setItem('customStyles', JSON.stringify(customStyles));
    showSaveStatus('ğŸ¨ æ ·å¼è®¾ç½®å·²ä¿å­˜', 2000);
    
    // å»¶è¿Ÿå…³é—­é¢æ¿ï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¿å­˜æˆåŠŸçš„æç¤º
    setTimeout(() => {
        closeStylePanel();
    }, 1000);
}

// é‡ç½®æ ·å¼åˆ°é»˜è®¤å€¼
function resetStyles() {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ ·å¼è®¾ç½®åˆ°é»˜è®¤å€¼å—ï¼Ÿ')) {
        // é‡ç½®è®¾ç½®å€¼
        customStyles = {
            fontSize: 'medium',
            fontFamily: 'default',
            backgroundType: 'gradient',
            gradientColor1: '#e68aff',
            gradientColor2: '#0984e3',
            gradientColor3: '#6c5ce7',
            solidColor: '#6c5ce7',
            backgroundImage: '',
            titleColor: '#ffffff',
            earningsColor: '#d22eff',
            countdownColor: '#ffffff',
            progressColor: '#ffffff',
            statusColor: '#ffffff',
            settingLabelColor: '#e68aff'
        };

        // æ›´æ–°ç•Œé¢æ§ä»¶
        loadStylesToInterface();
        
        // åº”ç”¨æ ·å¼
        applyStyles();
        
        // åˆ é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('customStyles');
        
        showSaveStatus('ğŸ”„ å·²é‡ç½®åˆ°é»˜è®¤æ ·å¼', 2000);
    }
}

// å°†æ ·å¼è®¾ç½®åŠ è½½åˆ°ç•Œé¢æ§ä»¶
function loadStylesToInterface() {
    document.getElementById('fontSize').value = customStyles.fontSize;
    document.getElementById('fontFamily').value = customStyles.fontFamily;
    document.getElementById('backgroundType').value = customStyles.backgroundType;
    document.getElementById('gradientColor1').value = customStyles.gradientColor1;
    document.getElementById('gradientColor2').value = customStyles.gradientColor2;
    document.getElementById('gradientColor3').value = customStyles.gradientColor3;
    document.getElementById('solidColor').value = customStyles.solidColor;
    document.getElementById('backgroundImage').value = customStyles.backgroundImage;
    document.getElementById('titleColor').value = customStyles.titleColor;
    document.getElementById('earningsColor').value = customStyles.earningsColor;
    document.getElementById('countdownColor').value = customStyles.countdownColor;
    document.getElementById('progressColor').value = customStyles.progressColor;
    document.getElementById('statusColor').value = customStyles.statusColor;
    document.getElementById('settingLabelColor').value = customStyles.settingLabelColor;
    
    // æ›´æ–°èƒŒæ™¯é€‰é¡¹æ˜¾ç¤º
    toggleBackgroundOptions();
}

// åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰æ ·å¼
function loadCustomStyles() {
    try {
        const saved = localStorage.getItem('customStyles');
        if (saved) {
            customStyles = { ...customStyles, ...JSON.parse(saved) };
            loadStylesToInterface();
            applyStyles();
        }
    } catch (error) {
        console.error('åŠ è½½è‡ªå®šä¹‰æ ·å¼æ—¶å‡ºé”™:', error);
    }
}

// åœ¨é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„æ ·å¼
window.addEventListener('DOMContentLoaded', function() {
    loadCustomStyles();
});
</script>
</body>

</html>
